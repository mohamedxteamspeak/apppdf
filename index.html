<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D47A1">
    <meta name="description" content="Ù…Ø­ÙˆÙ„ ØµÙˆØ± Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¥Ù„Ù‰ PDF - Created by Mohamed Elherd">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>Ù…Ø­ÙˆÙ„ ØµÙˆØ± Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¥Ù„Ù‰ PDF v5.1</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        :root {
            --primary: #0D47A1;
            --primary-light: #1976D2;
            --primary-dark: #002171;
            --secondary: #00C853;
            --surface: #1a1a2e;
            --surface-variant: #16213e;
            --background: #0f0f1a;
            --on-surface: #e8e8e8;
            --error: #CF6679;
            --success: #00E676;
            --warning: #FFB300;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        
        body {
            background: var(--background);
            color: var(--on-surface);
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù…Ø³ */
        button, .card, .radio-option, .checkbox-wrapper {
            touch-action: manipulation;
        }
        
        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        
        .install-banner.show {
            display: flex;
        }
        
        .page {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
            animation: fadeIn 0.3s ease-out;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 18px 32px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            min-height: 56px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn-primary:active {
            transform: scale(0.97);
        }
        
        .btn-primary:active::after {
            opacity: 1;
            animation: shimmer 0.6s ease;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--primary-light);
            padding: 16px 28px;
            border-radius: 16px;
            font-weight: 600;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            min-height: 54px;
        }
        
        .btn-secondary:active {
            background: rgba(25, 118, 210, 0.15);
            transform: scale(0.97);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00C853 0%, #00E676 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            min-height: 60px;
        }
        
        .btn-success:active {
            transform: scale(0.97);
        }
        
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .card.selected {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, rgba(13, 71, 161, 0.2) 0%, rgba(25, 118, 210, 0.1) 100%);
        }
        
        .icon-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            margin: 0 auto 20px;
            box-shadow: 0 8px 32px rgba(13, 71, 161, 0.4);
        }
        
        .progress-ring {
            width: 180px;
            height: 180px;
            position: relative;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 10;
        }
        
        .progress-ring .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }
        
        .progress-ring .progress {
            stroke: url(#gradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }
        
        .layout-grid {
            display: grid;
            gap: 4px;
            padding: 10px;
        }
        
        .layout-dot {
            width: 100%;
            aspect-ratio: 4/3;
            background: rgba(25, 118, 210, 0.3);
            border-radius: 2px;
            border: 1px solid rgba(25, 118, 210, 0.5);
        }
        
        .snackbar {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 85%;
            font-size: 0.9rem;
        }
        
        .snackbar.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .file-drop-zone {
            border: 3px dashed rgba(25, 118, 210, 0.5);
            border-radius: 24px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(25, 118, 210, 0.03);
        }
        
        .file-drop-zone:active, .file-drop-zone.dragover {
            border-color: var(--primary-light);
            background: rgba(25, 118, 210, 0.1);
            transform: scale(0.99);
        }
        
        .file-drop-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 18px;
            background: var(--surface);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .radio-option:active {
            transform: scale(0.98);
        }
        
        .radio-option.selected {
            border-color: var(--primary-light);
            background: rgba(25, 118, 210, 0.1);
        }
        
        .radio-circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .radio-option.selected .radio-circle {
            border-color: var(--primary-light);
            background: var(--primary-light);
        }
        
        .radio-circle::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
            transform: scale(0);
            transition: transform 0.2s ease;
        }
        
        .radio-option.selected .radio-circle::after {
            transform: scale(1);
        }
        
        input[type="text"] {
            width: 100%;
            background: var(--surface-variant);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 18px 20px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
            background: var(--surface);
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            padding: 10px 0;
        }
        
        .checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .checkbox.checked {
            background: var(--primary-light);
            border-color: var(--primary-light);
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-variant) 100%);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            max-height: 160px;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .image-preview img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: var(--background);
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: var(--primary-light);
            width: 28px;
            border-radius: 5px;
        }
        
        .step-dot.done {
            background: var(--success);
        }
        
        .analysis-box {
            background: var(--surface-variant);
            border-radius: 16px;
            padding: 14px;
            margin-top: 14px;
        }
        
        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-success { background: rgba(0, 200, 83, 0.2); color: #00E676; }
        .badge-warning { background: rgba(255, 179, 0, 0.2); color: #FFB300; }
        .badge-error { background: rgba(207, 102, 121, 0.2); color: #CF6679; }
        .badge-info { background: rgba(25, 118, 210, 0.2); color: #64B5F6; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 2px; }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 20px;
            padding: 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .extraction-log {
            background: var(--surface-variant);
            border-radius: 12px;
            padding: 10px;
            max-height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.7rem;
            color: #888;
            margin-top: 14px;
            -webkit-overflow-scrolling: touch;
        }
        
        .extraction-log .success { color: #00E676; }
        .extraction-log .warning { color: #FFB300; }
        .extraction-log .error { color: #CF6679; }
        .extraction-log .info { color: #64B5F6; }
        
        /* Bottom Fixed Button Area */
        .bottom-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: linear-gradient(to top, var(--background) 0%, var(--background) 60%, transparent 100%);
            z-index: 100;
        }
        
        /* Content padding for bottom button */
        .content-with-bottom {
            padding-bottom: 100px !important;
        }
        
        /* Safe area */
        @supports (padding: max(0px)) {
            .step-indicator {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }

        /* Smooth scrolling on iOS */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loading-text" class="text-lg text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        <div id="loading-progress" class="w-56 h-2 bg-gray-700 rounded-full overflow-hidden" style="display: none;">
            <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="loading-detail" class="text-sm text-gray-500 text-center"></p>
    </div>

    <!-- PWA Install Banner -->
    <div id="install-banner" class="install-banner">
        <div class="flex items-center gap-3">
            <span class="material-icons-round text-white">get_app</span>
            <div>
                <p class="font-bold text-white text-sm">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
                <p class="text-white/70 text-xs">Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="installPWA()" class="bg-white text-blue-900 px-4 py-2 rounded-lg font-bold text-sm">ØªØ«Ø¨ÙŠØª</button>
            <button onclick="dismissInstall()" class="text-white/70 px-2 text-xl">âœ•</button>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
    <div id="page-welcome" class="page active">
        <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="text-center mb-10">
                <div class="icon-circle mb-6" style="width: 100px; height: 100px;">
                    <span class="material-icons-round text-white" style="font-size: 50px;">auto_awesome</span>
                </div>
                <h1 class="text-2xl font-bold mb-3 bg-gradient-to-l from-blue-400 to-blue-600 bg-clip-text text-transparent">
                    Ù…Ø­ÙˆÙ„ ØµÙˆØ± Ø§Ù„Ø¯Ø±ÙˆØ³
                </h1>
                <p class="text-gray-400 text-base mb-2">Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª PDF Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
                <p class="text-gray-600 text-xs">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5.1 - Mohamed Elherd</p>
            </div>
            
            <div class="w-full max-w-sm space-y-4">
                <button onclick="startWithPDF()" class="btn-primary">
                    <span class="material-icons-round">picture_as_pdf</span>
                    Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† PDF
                </button>
                <button onclick="startWithFolder()" class="btn-secondary">
                    <span class="material-icons-round">folder_open</span>
                    Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¬Ù„Ø¯ ØµÙˆØ±
                </button>
            </div>
            
            <div class="mt-8 glass rounded-2xl p-4 max-w-sm w-full">
                <div class="flex items-start gap-3 text-sm text-gray-400">
                    <span class="material-icons-round text-blue-400 mt-0.5">info</span>
                    <div>
                        <p class="font-semibold text-white mb-2">Ø§Ù„Ù…ÙŠØ²Ø§Øª v5.1:</p>
                        <ul class="space-y-1 text-xs">
                            <li>â€¢ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† PDF</li>
                            <li>â€¢ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                            <li>â€¢ 7 ØªØ®Ø·ÙŠØ·Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ØµÙØ­Ø©</li>
                            <li>â€¢ ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† Ù†ÙˆØ§ÙØ°</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="step-indicator">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù -->
    <div id="page-file" class="page">
        <div class="gradient-bg p-5 pb-10">
            <button onclick="goToPage('welcome')" class="flex items-center gap-2 text-white/70 mb-3">
                <span class="material-icons-round">arrow_forward</span>
                Ø±Ø¬ÙˆØ¹
            </button>
            <h2 class="text-xl font-bold text-white" id="file-page-title">Ø§Ø®ØªØ± Ù…Ù„Ù PDF</h2>
            <p class="text-white/70 text-sm mt-1" id="file-page-subtitle">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±</p>
        </div>
        
        <div class="flex-1 p-5 -mt-5 overflow-auto scroll-container content-with-bottom">
            <div id="file-drop-zone" class="file-drop-zone" onclick="triggerFileInput()">
                <div class="icon-circle mx-auto mb-4" style="width: 56px; height: 56px;">
                    <span class="material-icons-round text-white" style="font-size: 28px;" id="file-icon">upload_file</span>
                </div>
                <p class="text-base font-semibold mb-1" id="file-name-display">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</p>
                <p class="text-gray-500 text-sm" id="file-hint">Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>
            
            <input type="file" id="pdf-input" accept=".pdf" hidden onchange="handleFileSelect(event)">
            <input type="file" id="folder-input" webkitdirectory multiple hidden onchange="handleFolderSelect(event)">
            
            <div id="extraction-log-container" class="hidden">
                <div class="extraction-log" id="extraction-log"></div>
            </div>
            
            <div id="analysis-section" class="hidden mt-5">
                <h3 class="font-bold text-base mb-3 flex items-center gap-2">
                    <span class="material-icons-round text-green-400">analytics</span>
                    Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„
                </h3>
                
                <div class="analysis-box">
                    <div class="analysis-item">
                        <span class="flex items-center gap-2">
                            <span class="material-icons-round text-blue-400 text-lg">image</span>
                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
                        </span>
                        <span class="badge badge-info" id="total-extracted">0</span>
                    </div>
                    <div class="analysis-item">
                        <span class="flex items-center gap-2">
                            <span class="material-icons-round text-green-400 text-lg">check_circle</span>
                            ØµÙˆØ± ØµØ§Ù„Ø­Ø©
                        </span>
                        <span class="badge badge-success" id="valid-images">0</span>
                    </div>
                    <div class="analysis-item">
                        <span class="flex items-center gap-2">
                            <span class="material-icons-round text-amber-400 text-lg">content_copy</span>
                            Ù…ÙƒØ±Ø±Ø©
                        </span>
                        <span class="badge badge-warning" id="duplicate-count">0</span>
                    </div>
                    <div class="analysis-item">
                        <span class="flex items-center gap-2">
                            <span class="material-icons-round text-red-400 text-lg">logo_dev</span>
                            Ø´Ø¹Ø§Ø±Ø§Øª
                        </span>
                        <span class="badge badge-error" id="logo-count">0</span>
                    </div>
                </div>
                
                <div id="images-preview" class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-xs text-gray-400">Ù…Ø¹Ø§ÙŠÙ†Ø©</h4>
                        <span class="text-blue-400 text-xs" id="images-count">0 ØµÙˆØ±Ø©</span>
                    </div>
                    <div class="image-preview card" id="preview-grid"></div>
                </div>
            </div>
        </div>
        
        <div id="file-bottom-action" class="bottom-action hidden">
            <button id="next-to-filter" onclick="goToPage('filter')" class="btn-primary">
                Ø§Ù„ØªØ§Ù„ÙŠ - Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµÙÙŠØ©
                <span class="material-icons-round">arrow_back</span>
            </button>
        </div>
        
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµÙÙŠØ© -->
    <div id="page-filter" class="page">
        <div class="gradient-bg p-5 pb-10">
            <button onclick="goToPage('file')" class="flex items-center gap-2 text-white/70 mb-3">
                <span class="material-icons-round">arrow_forward</span>
                Ø±Ø¬ÙˆØ¹
            </button>
            <h2 class="text-xl font-bold text-white">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµÙÙŠØ©</h2>
            <p class="text-white/70 text-sm mt-1">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØµÙÙŠØ©</p>
        </div>
        
        <div class="flex-1 p-5 -mt-5 space-y-3 overflow-auto scroll-container content-with-bottom">
            <div class="radio-option selected" data-filter="1" onclick="selectFilter(1)">
                <div class="radio-circle"></div>
                <div class="flex-1">
                    <h3 class="font-semibold">ğŸ”° ØªØµÙÙŠØ© ÙƒØ§Ù…Ù„Ø© (Ù…ÙˆØµÙ‰)</h3>
                    <p class="text-gray-400 text-xs mt-1">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª + Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª</p>
                    <p class="text-green-400 text-xs mt-1" id="filter1-stats"></p>
                </div>
            </div>
            
            <div class="radio-option" data-filter="2" onclick="selectFilter(2)">
                <div class="radio-circle"></div>
                <div class="flex-1">
                    <h3 class="font-semibold">ğŸ”„ ØªÙƒØ±Ø§Ø±Ø§Øª ÙÙ‚Ø·</h3>
                    <p class="text-gray-400 text-xs mt-1">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§ØªØŒ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª</p>
                    <p class="text-amber-400 text-xs mt-1" id="filter2-stats"></p>
                </div>
            </div>
            
            <div class="radio-option" data-filter="3" onclick="selectFilter(3)">
                <div class="radio-circle"></div>
                <div class="flex-1">
                    <h3 class="font-semibold">âŒ Ø¨Ø¯ÙˆÙ† ØªØµÙÙŠØ©</h3>
                    <p class="text-gray-400 text-xs mt-1">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ÙƒÙ…Ø§ Ù‡ÙŠ</p>
                    <p class="text-blue-400 text-xs mt-1" id="filter3-stats"></p>
                </div>
            </div>
            
            <div class="glass rounded-xl p-4 mt-4">
                <div class="flex items-start gap-3">
                    <span class="material-icons-round text-amber-400">lightbulb</span>
                    <p class="text-xs text-gray-400">
                        <span class="text-white font-semibold">Ù†ØµÙŠØ­Ø©:</span>
                        Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ØªØ¹Ø·ÙŠ Ø£ÙØ¶Ù„ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bottom-action">
            <button onclick="goToPage('layout')" class="btn-primary">
                Ø§Ù„ØªØ§Ù„ÙŠ - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®Ø·ÙŠØ·
                <span class="material-icons-round">arrow_back</span>
            </button>
        </div>
        
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®Ø·ÙŠØ· -->
    <div id="page-layout" class="page">
        <div class="gradient-bg p-5 pb-10">
            <button onclick="goToPage('filter')" class="flex items-center gap-2 text-white/70 mb-3">
                <span class="material-icons-round">arrow_forward</span>
                Ø±Ø¬ÙˆØ¹
            </button>
            <h2 class="text-xl font-bold text-white">ØªØ®Ø·ÙŠØ· Ø§Ù„ØµÙØ­Ø©</h2>
            <p class="text-white/70 text-sm mt-1">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©</p>
        </div>
        
        <div class="flex-1 p-5 -mt-5 overflow-auto scroll-container content-with-bottom">
            <div class="grid grid-cols-3 gap-3" id="layout-grid"></div>
            
            <div class="mt-5 p-4 glass rounded-xl">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</span>
                    <span class="font-bold text-xl text-blue-400" id="expected-pages">0</span>
                </div>
            </div>
        </div>
        
        <div class="bottom-action">
            <button onclick="goToPage('settings')" class="btn-primary">
                Ø§Ù„ØªØ§Ù„ÙŠ - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                <span class="material-icons-round">arrow_back</span>
            </button>
        </div>
        
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
    <div id="page-settings" class="page">
        <div class="gradient-bg p-5 pb-10">
            <button onclick="goToPage('layout')" class="flex items-center gap-2 text-white/70 mb-3">
                <span class="material-icons-round">arrow_forward</span>
                Ø±Ø¬ÙˆØ¹
            </button>
            <h2 class="text-xl font-bold text-white">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <p class="text-white/70 text-sm mt-1">ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ù„Ù</p>
        </div>
        
        <div class="flex-1 p-5 -mt-5 space-y-5 overflow-auto scroll-container content-with-bottom">
            <div>
                <label class="block text-sm font-medium mb-2 text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</label>
                <input type="text" id="output-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù">
            </div>
            
            <div class="checkbox-wrapper" onclick="toggleAutoOpen()">
                <div class="checkbox checked" id="auto-open-checkbox">
                    <span class="material-icons-round text-white text-sm">check</span>
                </div>
                <span class="text-sm">ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
            </div>
            
            <div class="card">
                <h3 class="font-semibold mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-blue-400">summarize</span>
                    Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£ØµÙ„ÙŠØ©:</span>
                        <span class="font-medium" id="summary-total">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:</span>
                        <span class="font-medium text-green-400" id="summary-filtered">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (ØªÙƒØ±Ø§Ø±):</span>
                        <span class="font-medium text-amber-400" id="summary-duplicates">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (Ø´Ø¹Ø§Ø±Ø§Øª):</span>
                        <span class="font-medium text-red-400" id="summary-logos">0</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-700 pt-2 mt-2">
                        <span class="text-gray-400">Ø§Ù„ØªØ®Ø·ÙŠØ·:</span>
                        <span class="font-medium" id="summary-layout">6/ØµÙØ­Ø©</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª:</span>
                        <span class="font-medium text-blue-400" id="summary-pages">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-action">
            <button onclick="startProcessing()" class="btn-success">
                <span class="material-icons-round">play_arrow</span>
                Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„
            </button>
        </div>
        
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <div id="page-processing" class="page">
        <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="progress-ring mb-6">
                <svg width="180" height="180">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#0D47A1"/>
                            <stop offset="100%" stop-color="#00E676"/>
                        </linearGradient>
                    </defs>
                    <circle class="bg" cx="90" cy="90" r="80"/>
                    <circle class="progress" cx="90" cy="90" r="80" 
                            stroke-dasharray="502.65" 
                            stroke-dashoffset="502.65"
                            id="progress-circle"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-3xl font-bold" id="progress-percent">0%</span>
                </div>
            </div>
            
            <h2 class="text-lg font-bold mb-2" id="progress-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h2>
            <p class="text-gray-400 text-sm text-center" id="progress-status">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
            
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs mt-6">
                <div class="stats-card">
                    <div class="stats-value" id="stat-processed">0</div>
                    <div class="text-gray-400 text-xs">ØµÙˆØ±Ø© Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="stat-pages">0</div>
                    <div class="text-gray-400 text-xs">ØµÙØ­Ø©</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div id="page-result" class="page">
        <div class="flex-1 p-5 overflow-auto scroll-container">
            <div class="text-center mb-6">
                <div class="icon-circle mb-4" style="width: 80px; height: 80px; background: linear-gradient(135deg, #00C853 0%, #00E676 100%);">
                    <span class="material-icons-round text-white" style="font-size: 40px;">check_circle</span>
                </div>
                <h1 class="text-xl font-bold mb-1">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</h1>
                <p class="text-gray-400 text-sm">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-5">
                <div class="stats-card">
                    <div class="stats-value" id="result-images">0</div>
                    <div class="text-gray-400 text-xs">ØµÙˆØ±Ø©</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="result-pages">0</div>
                    <div class="text-gray-400 text-xs">ØµÙØ­Ø©</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="result-duplicates">0</div>
                    <div class="text-gray-400 text-xs">ØªÙƒØ±Ø§Ø± Ù…Ø­Ø°ÙˆÙ</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="result-logos">0</div>
                    <div class="text-gray-400 text-xs">Ø´Ø¹Ø§Ø± Ù…Ø­Ø°ÙˆÙ</div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="downloadPDF()" class="btn-primary">
                    <span class="material-icons-round">download</span>
                    ØªØ­Ù…ÙŠÙ„ PDF
                </button>
                
                <button onclick="sharePDF()" class="btn-secondary">
                    <span class="material-icons-round">share</span>
                    Ù…Ø´Ø§Ø±ÙƒØ©
                </button>
                
                <div id="duplicates-review" class="hidden">
                    <button onclick="reviewDuplicates()" class="btn-secondary border-amber-500 text-amber-500">
                        <span class="material-icons-round">visibility</span>
                        Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª (<span id="dup-review-count">0</span>)
                    </button>
                </div>
                
                <button onclick="startNew()" class="btn-secondary">
                    <span class="material-icons-round">refresh</span>
                    Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
            
            <div class="mt-6 text-center text-gray-600 text-xs">
                <p>Created by Mohamed Elherd</p>
                <p>Version 5.1</p>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª -->
    <div id="duplicates-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--surface)] rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden">
            <div class="p-5 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙƒØ±Ø±Ø©</h3>
                    <button onclick="closeDuplicatesModal()" class="text-gray-400 p-2">
                        <span class="material-icons-round">close</span>
                    </button>
                </div>
            </div>
            <div class="p-5 overflow-auto max-h-[50vh] scroll-container">
                <div class="grid grid-cols-3 gap-2" id="duplicates-grid"></div>
            </div>
            <div class="p-5 border-t border-gray-700">
                <button onclick="closeDuplicatesModal()" class="btn-primary">
                    Ø­Ø³Ù†Ø§Ù‹
                </button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar" class="snackbar">
        <span class="material-icons-round" id="snackbar-icon">info</span>
        <span id="snackbar-message">Ø±Ø³Ø§Ù„Ø©</span>
    </div>

    <script>
        // =====================================================
        // Configuration
        // =====================================================
        const Config = {
            MIN_WIDTH: 100,
            MIN_HEIGHT: 100,
            MAX_LOGO_SIZE: 50000,
            HASH_SIZE: 64,
            LAYOUTS: {
                1: { cols: 1, rows: 2, name: '2/ØµÙØ­Ø©', images: 2 },
                2: { cols: 2, rows: 2, name: '4/ØµÙØ­Ø©', images: 4 },
                3: { cols: 2, rows: 3, name: '6/ØµÙØ­Ø©', images: 6 },
                4: { cols: 3, rows: 3, name: '9/ØµÙØ­Ø©', images: 9 },
                5: { cols: 3, rows: 4, name: '12/ØµÙØ­Ø©', images: 12 },
                6: { cols: 4, rows: 4, name: '16/ØµÙØ­Ø©', images: 16 },
                7: { cols: 4, rows: 6, name: '24/ØµÙØ­Ø©', images: 24 }
            }
        };

        // =====================================================
        // Global Variables
        // =====================================================
        let mode = 'pdf';
        let selectedFile = null;
        let allExtractedImages = [];
        let validImages = [];
        let uniqueImages = [];
        let duplicateImages = [];
        let logoImages = [];
        let filterOption = 1;
        let layoutOption = 3;
        let autoOpen = true;
        let generatedPDF = null;
        let pdfBlob = null;
        let baseName = 'lesson';
        let deferredPrompt = null;
        
        let analysisResults = {
            total: 0,
            valid: 0,
            duplicates: 0,
            logos: 0
        };

        const __version__ = '5.1';

        // =====================================================
        // PWA Support
        // =====================================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-banner').classList.add('show');
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.getElementById('install-banner').classList.remove('show');
                });
            }
        }
        
        function dismissInstall() {
            document.getElementById('install-banner').classList.remove('show');
        }

        // =====================================================
        // Initialize
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            initLayoutGrid();
            loadSettings();
            setupDragDrop();
        });

        function setupDragDrop() {
            const dropZone = document.getElementById('file-drop-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'));
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'));
            });
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (mode === 'pdf' && files[0].type === 'application/pdf') {
                        document.getElementById('pdf-input').files = files;
                        handleFileSelect({ target: { files } });
                    } else if (mode === 'folder') {
                        handleFolderSelect({ target: { files } });
                    }
                }
            });
        }

        // =====================================================
        // Logging
        // =====================================================
        function log(message, type = 'info') {
            const logContainer = document.getElementById('extraction-log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showLog() {
            document.getElementById('extraction-log-container').classList.remove('hidden');
            document.getElementById('extraction-log').innerHTML = '';
        }

        function hideLog() {
            document.getElementById('extraction-log-container').classList.add('hidden');
        }

        // =====================================================
        // Navigation
        // =====================================================
        function goToPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            if (pageId === 'filter') {
                updateFilterStats();
            } else if (pageId === 'layout') {
                updateExpectedPages();
            } else if (pageId === 'settings') {
                updateSummary();
            }
        }

        function startWithPDF() {
            mode = 'pdf';
            document.getElementById('file-page-title').textContent = 'Ø§Ø®ØªØ± Ù…Ù„Ù PDF';
            document.getElementById('file-page-subtitle').textContent = 'Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±';
            document.getElementById('file-icon').textContent = 'picture_as_pdf';
            resetFileState();
            goToPage('file');
        }

        function startWithFolder() {
            mode = 'folder';
            document.getElementById('file-page-title').textContent = 'Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙˆØ±';
            document.getElementById('file-page-subtitle').textContent = 'Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±';
            document.getElementById('file-icon').textContent = 'folder_open';
            resetFileState();
            goToPage('file');
        }

        function resetFileState() {
            allExtractedImages = [];
            validImages = [];
            uniqueImages = [];
            duplicateImages = [];
            logoImages = [];
            document.getElementById('analysis-section').classList.add('hidden');
            document.getElementById('file-bottom-action').classList.add('hidden');
            document.getElementById('file-name-display').textContent = 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
            document.getElementById('file-hint').textContent = 'Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§';
            hideLog();
        }

        // =====================================================
        // File Selection
        // =====================================================
        function triggerFileInput() {
            if (mode === 'pdf') {
                document.getElementById('pdf-input').click();
            } else {
                document.getElementById('folder-input').click();
            }
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            baseName = file.name.replace('.pdf', '');
            
            document.getElementById('file-name-display').textContent = file.name;
            document.getElementById('file-hint').textContent = formatFileSize(file.size);
            document.getElementById('file-drop-zone').classList.add('processing');
            
            showLog();
            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† PDF...');
            
            try {
                log(`ÙØªØ­ Ø§Ù„Ù…Ù„Ù: ${file.name}`, 'info');
                allExtractedImages = await extractImagesFromPDF(file);
                
                if (allExtractedImages.length === 0) {
                    log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ± Ù…Ø¶Ù…Ù†Ø©ØŒ Ø¬Ø§Ø±ÙŠ ØªØ¬Ø±Ø¨Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª...', 'warning');
                    updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø¥Ù„Ù‰ ØµÙˆØ±...');
                    allExtractedImages = await extractPagesAsImages(file);
                }
                
                if (allExtractedImages.length === 0) {
                    hideLoading();
                    showSnackbar('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ù„Ù', 'error');
                    document.getElementById('file-drop-zone').classList.remove('processing');
                    return;
                }
                
                log(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${allExtractedImages.length} ØµÙˆØ±Ø©`, 'success');
                updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±...');
                await analyzeImages();
                
                hideLoading();
                displayAnalysisResults();
                document.getElementById('file-drop-zone').classList.remove('processing');
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                document.getElementById('output-name').value = baseName + '_images';
                
            } catch (error) {
                console.error('Error:', error);
                log(`Ø®Ø·Ø£: ${error.message}`, 'error');
                hideLoading();
                showSnackbar('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF: ' + error.message, 'error');
                document.getElementById('file-drop-zone').classList.remove('processing');
            }
        }

        async function handleFolderSelect(event) {
            const files = Array.from(event.target.files).filter(f => 
                f.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/i.test(f.name)
            );
            
            if (files.length === 0) {
                showSnackbar('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯', 'error');
                return;
            }
            
            files.sort((a, b) => a.name.localeCompare(b.name, 'ar', { numeric: true }));
            
            const folderPath = files[0].webkitRelativePath?.split('/')[0] || 'images';
            baseName = folderPath;
            
            document.getElementById('file-name-display').textContent = `${files.length} ØµÙˆØ±Ø©`;
            document.getElementById('file-hint').textContent = `Ù…Ù† Ù…Ø¬Ù„Ø¯: ${folderPath}`;
            document.getElementById('file-drop-zone').classList.add('processing');
            
            showLog();
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...');
            
            try {
                allExtractedImages = [];
                let counter = 0;
                
                for (const file of files) {
                    counter++;
                    log(`ØªØ­Ù…ÙŠÙ„: ${file.name}`, 'info');
                    
                    const dataUrl = await readFileAsDataURL(file);
                    const dims = await getImageDimensions(dataUrl);
                    
                    allExtractedImages.push({
                        data: dataUrl,
                        name: `img_${String(counter).padStart(4, '0')}_${file.name}`,
                        width: dims.width,
                        height: dims.height,
                        size: file.size,
                        loaded: true
                    });
                    
                    updateLoadingText(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±... ${counter}/${files.length}`);
                }
                
                log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allExtractedImages.length} ØµÙˆØ±Ø©`, 'success');
                updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±...');
                await analyzeImages();
                
                hideLoading();
                displayAnalysisResults();
                document.getElementById('file-drop-zone').classList.remove('processing');
                
                document.getElementById('output-name').value = baseName + '_images';
                
            } catch (error) {
                console.error('Error:', error);
                log(`Ø®Ø·Ø£: ${error.message}`, 'error');
                hideLoading();
                showSnackbar('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±', 'error');
                document.getElementById('file-drop-zone').classList.remove('processing');
            }
        }

        // =====================================================
        // PDF Image Extraction - Method 1: Extract embedded images
        // =====================================================
        async function extractImagesFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];
            let globalCounter = 0;
            
            log(`Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª: ${pdf.numPages}`, 'info');
            showLoadingProgress(true);
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                try {
                    updateLoadingText(`Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù† ØµÙØ­Ø© ${pageNum}/${pdf.numPages}...`);
                    updateLoadingBar((pageNum / pdf.numPages) * 100);
                    
                    const page = await pdf.getPage(pageNum);
                    const ops = await page.getOperatorList();
                    
                    const pageImages = new Set();
                    
                    for (let i = 0; i < ops.fnArray.length; i++) {
                        const fn = ops.fnArray[i];
                        if (fn === 85 || fn === 82 || fn === 83) {
                            const imgName = ops.argsArray[i][0];
                            if (imgName) pageImages.add(imgName);
                        }
                    }
                    
                    log(`ØµÙØ­Ø© ${pageNum}: ${pageImages.size} ØµÙˆØ±Ø©`, pageImages.size > 0 ? 'success' : 'warning');
                    
                    let imgIndex = 0;
                    for (const imgName of pageImages) {
                        try {
                            const imgObj = await Promise.race([
                                new Promise((resolve, reject) => {
                                    page.objs.get(imgName, (img) => {
                                        if (img) resolve(img);
                                        else reject(new Error('Image not found'));
                                    });
                                }),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
                            ]);
                            
                            if (imgObj && imgObj.width && imgObj.height && imgObj.width > 50 && imgObj.height > 50) {
                                globalCounter++;
                                imgIndex++;
                                
                                const canvas = document.createElement('canvas');
                                canvas.width = imgObj.width;
                                canvas.height = imgObj.height;
                                const ctx = canvas.getContext('2d');
                                
                                if (imgObj.data) {
                                    const imageData = ctx.createImageData(imgObj.width, imgObj.height);
                                    const srcData = imgObj.data;
                                    const dstData = imageData.data;
                                    const pixelCount = imgObj.width * imgObj.height;
                                    
                                    if (srcData.length === pixelCount * 4) {
                                        dstData.set(srcData);
                                    } else if (srcData.length === pixelCount * 3) {
                                        for (let j = 0; j < pixelCount; j++) {
                                            dstData[j * 4] = srcData[j * 3];
                                            dstData[j * 4 + 1] = srcData[j * 3 + 1];
                                            dstData[j * 4 + 2] = srcData[j * 3 + 2];
                                            dstData[j * 4 + 3] = 255;
                                        }
                                    } else if (srcData.length === pixelCount) {
                                        for (let j = 0; j < pixelCount; j++) {
                                            const gray = srcData[j];
                                            dstData[j * 4] = gray;
                                            dstData[j * 4 + 1] = gray;
                                            dstData[j * 4 + 2] = gray;
                                            dstData[j * 4 + 3] = 255;
                                        }
                                    } else {
                                        continue;
                                    }
                                    
                                    ctx.putImageData(imageData, 0, 0);
                                } else if (imgObj.bitmap) {
                                    ctx.drawImage(imgObj.bitmap, 0, 0);
                                } else {
                                    continue;
                                }
                                
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
                                const base64 = dataUrl.split(',')[1];
                                const estimatedSize = Math.round(base64.length * 0.75);
                                
                                images.push({
                                    data: dataUrl,
                                    name: `img_${String(globalCounter).padStart(4, '0')}_p${String(pageNum).padStart(3, '0')}_${String(imgIndex).padStart(2, '0')}.jpg`,
                                    width: imgObj.width,
                                    height: imgObj.height,
                                    size: estimatedSize,
                                    pageNum: pageNum,
                                    loaded: true
                                });
                            }
                        } catch (e) {
                            // Skip this image
                        }
                    }
                    
                    await new Promise(r => setTimeout(r, 10));
                    
                } catch (e) {
                    log(`Ø®Ø·Ø£ ÙÙŠ ØµÙØ­Ø© ${pageNum}: ${e.message}`, 'error');
                }
            }
            
            showLoadingProgress(false);
            return images;
        }

        // =====================================================
        // PDF Image Extraction - Method 2: Render pages as images
        // =====================================================
        async function extractPagesAsImages(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];
            
            log(`ØªØ­ÙˆÙŠÙ„ ${pdf.numPages} ØµÙØ­Ø© Ø¥Ù„Ù‰ ØµÙˆØ±...`, 'info');
            showLoadingProgress(true);
            
            const scale = 2;
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                try {
                    updateLoadingText(`ØªØ­ÙˆÙŠÙ„ ØµÙØ­Ø© ${pageNum}/${pdf.numPages}...`);
                    updateLoadingBar((pageNum / pdf.numPages) * 100);
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
                    const base64 = dataUrl.split(',')[1];
                    const estimatedSize = Math.round(base64.length * 0.75);
                    
                    images.push({
                        data: dataUrl,
                        name: `img_${String(pageNum).padStart(4, '0')}_p${String(pageNum).padStart(3, '0')}_01.jpg`,
                        width: viewport.width,
                        height: viewport.height,
                        size: estimatedSize,
                        pageNum: pageNum,
                        loaded: true
                    });
                    
                    log(`ØµÙØ­Ø© ${pageNum}: ØªÙ… (${Math.round(viewport.width)}x${Math.round(viewport.height)})`, 'success');
                    
                    await new Promise(r => setTimeout(r, 10));
                    
                } catch (e) {
                    log(`Ø®Ø·Ø£ ÙÙŠ ØµÙØ­Ø© ${pageNum}: ${e.message}`, 'error');
                }
            }
            
            showLoadingProgress(false);
            return images;
        }

        // =====================================================
        // Image Analysis
        // =====================================================
        async function analyzeImages() {
            validImages = [];
            uniqueImages = [];
            duplicateImages = [];
            logoImages = [];
            
            const hashes = new Map();
            
            log('Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±...', 'info');
            
            for (let i = 0; i < allExtractedImages.length; i++) {
                const img = allExtractedImages[i];
                
                if (isLogo(img)) {
                    logoImages.push(img);
                    log(`[Ø´Ø¹Ø§Ø±] ${img.name} (${img.width}x${img.height})`, 'warning');
                    continue;
                }
                
                validImages.push(img);
                
                const hash = await getImageHash(img.data);
                
                if (hashes.has(hash)) {
                    duplicateImages.push({
                        ...img,
                        originalName: hashes.get(hash)
                    });
                    log(`[Ù…ÙƒØ±Ø±] ${img.name}`, 'warning');
                } else {
                    hashes.set(hash, img.name);
                    uniqueImages.push(img);
                    log(`[ØµØ§Ù„Ø­] ${img.name}`, 'success');
                }
            }
            
            analysisResults = {
                total: allExtractedImages.length,
                valid: validImages.length,
                logos: logoImages.length,
                duplicates: duplicateImages.length,
                unique: uniqueImages.length
            };
            
            log(`Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ÙƒØªÙ…Ù„: ${analysisResults.unique} ØµØ§Ù„Ø­Ø©ØŒ ${analysisResults.duplicates} Ù…ÙƒØ±Ø±Ø©ØŒ ${analysisResults.logos} Ø´Ø¹Ø§Ø±Ø§Øª`, 'success');
        }

        function isLogo(img) {
            if (img.width < Config.MIN_WIDTH || img.height < Config.MIN_HEIGHT) {
                return true;
            }
            if (img.size < Config.MAX_LOGO_SIZE && img.width < 200 && img.height < 200) {
                return true;
            }
            return false;
        }

        async function getImageHash(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = Config.HASH_SIZE;
                    canvas.height = Config.HASH_SIZE;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, Config.HASH_SIZE, Config.HASH_SIZE);
                    
                    const imageData = ctx.getImageData(0, 0, Config.HASH_SIZE, Config.HASH_SIZE).data;
                    
                    let hash = '';
                    let total = 0;
                    const grays = [];
                    
                    for (let i = 0; i < imageData.length; i += 4) {
                        const gray = Math.round((imageData[i] + imageData[i+1] + imageData[i+2]) / 3);
                        grays.push(gray);
                        total += gray;
                    }
                    
                    const avg = total / grays.length;
                    
                    for (const gray of grays) {
                        hash += gray > avg ? '1' : '0';
                    }
                    
                    resolve(hash);
                };
                img.onerror = () => resolve(Math.random().toString());
                img.src = dataUrl;
            });
        }

        // =====================================================
        // Display Analysis Results
        // =====================================================
        function displayAnalysisResults() {
            document.getElementById('analysis-section').classList.remove('hidden');
            
            document.getElementById('total-extracted').textContent = analysisResults.total;
            document.getElementById('valid-images').textContent = analysisResults.unique;
            document.getElementById('duplicate-count').textContent = analysisResults.duplicates;
            document.getElementById('logo-count').textContent = analysisResults.logos;
            document.getElementById('images-count').textContent = `${analysisResults.unique} ØµÙˆØ±Ø©`;
            
            const grid = document.getElementById('preview-grid');
            const previewImages = uniqueImages.slice(0, 12);
            
            grid.innerHTML = previewImages.map((img, i) => 
                `<img src="${img.data}" alt="ØµÙˆØ±Ø© ${i + 1}" loading="lazy">`
            ).join('');
            
            if (uniqueImages.length > 12) {
                grid.innerHTML += `
                    <div class="w-full aspect-square bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 text-xs">
                        +${uniqueImages.length - 12}
                    </div>
                `;
            }
            
            document.getElementById('file-bottom-action').classList.remove('hidden');
            
            showSnackbar(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${analysisResults.total} ØµÙˆØ±Ø©ØŒ ${analysisResults.unique} ØµØ§Ù„Ø­Ø©`, 'success');
        }

        // =====================================================
        // Filter Options
        // =====================================================
        function selectFilter(option) {
            filterOption = option;
            document.querySelectorAll('.radio-option').forEach(el => {
                el.classList.remove('selected');
                if (parseInt(el.dataset.filter) === option) {
                    el.classList.add('selected');
                }
            });
            updateExpectedPages();
        }

        function updateFilterStats() {
            const fullFilter = uniqueImages.length;
            const dupOnly = validImages.length;
            const noFilter = allExtractedImages.length;
            
            document.getElementById('filter1-stats').textContent = 
                `â† ${fullFilter} ØµÙˆØ±Ø©`;
            document.getElementById('filter2-stats').textContent = 
                `â† ${dupOnly} ØµÙˆØ±Ø©`;
            document.getElementById('filter3-stats').textContent = 
                `â† ${noFilter} ØµÙˆØ±Ø©`;
        }

        function getFilteredImages() {
            switch (filterOption) {
                case 1:
                    return uniqueImages;
                case 2:
                    return allExtractedImages.filter(img => 
                        !duplicateImages.find(d => d.name === img.name)
                    );
                case 3:
                    return allExtractedImages;
                default:
                    return uniqueImages;
            }
        }

        // =====================================================
        // Layout Selection
        // =====================================================
        function initLayoutGrid() {
            const grid = document.getElementById('layout-grid');
            grid.innerHTML = Object.entries(Config.LAYOUTS).map(([key, layout]) => `
                <div class="card cursor-pointer ${key === '3' ? 'selected' : ''}" 
                     data-layout="${key}" 
                     onclick="selectLayout(${key})">
                    <div class="layout-grid" style="grid-template-columns: repeat(${layout.cols}, 1fr);">
                        ${Array(Math.min(layout.images, 12)).fill('<div class="layout-dot"></div>').join('')}
                    </div>
                    <p class="text-center mt-2 text-xs font-medium">${layout.name}</p>
                </div>
            `).join('');
        }

        function selectLayout(key) {
            layoutOption = key;
            document.querySelectorAll('#layout-grid .card').forEach(el => {
                el.classList.remove('selected');
                if (parseInt(el.dataset.layout) === key) {
                    el.classList.add('selected');
                }
            });
            updateExpectedPages();
        }

        function updateExpectedPages() {
            const images = getFilteredImages();
            const layout = Config.LAYOUTS[layoutOption];
            const perPage = layout.cols * layout.rows;
            const pages = Math.ceil(images.length / perPage);
            document.getElementById('expected-pages').textContent = pages;
        }

        // =====================================================
        // Settings
        // =====================================================
        function toggleAutoOpen() {
            autoOpen = !autoOpen;
            const checkbox = document.getElementById('auto-open-checkbox');
            checkbox.classList.toggle('checked', autoOpen);
        }

        function updateSummary() {
            const images = getFilteredImages();
            const layout = Config.LAYOUTS[layoutOption];
            const perPage = layout.cols * layout.rows;
            const pages = Math.ceil(images.length / perPage);
            
            let removedDuplicates = 0;
            let removedLogos = 0;
            
            if (filterOption === 1) {
                removedDuplicates = analysisResults.duplicates;
                removedLogos = analysisResults.logos;
            } else if (filterOption === 2) {
                removedDuplicates = analysisResults.duplicates;
            }
            
            document.getElementById('summary-total').textContent = analysisResults.total;
            document.getElementById('summary-filtered').textContent = images.length;
            document.getElementById('summary-duplicates').textContent = removedDuplicates;
            document.getElementById('summary-logos').textContent = removedLogos;
            document.getElementById('summary-layout').textContent = `${layout.images}/ØµÙØ­Ø©`;
            document.getElementById('summary-pages').textContent = pages;
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('lesson_converter_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    filterOption = settings.filterOption || 1;
                    layoutOption = settings.layoutOption || 3;
                    autoOpen = settings.autoOpen !== false;
                }
            } catch (e) {}
        }

        function saveSettings() {
            try {
                localStorage.setItem('lesson_converter_settings', JSON.stringify({
                    filterOption,
                    layoutOption,
                    autoOpen
                }));
            } catch (e) {}
        }

        // =====================================================
        // PDF Creation - Fixed Version
        // =====================================================
        async function startProcessing() {
            saveSettings();
            goToPage('processing');
            
            const images = getFilteredImages();
            const layout = Config.LAYOUTS[layoutOption];
            
            try {
                await createPDF(images, layout);
                
                setTimeout(() => {
                    showResults();
                    if (autoOpen) {
                        setTimeout(downloadPDF, 500);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error creating PDF:', error);
                showSnackbar('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF: ' + error.message, 'error');
                goToPage('settings');
            }
        }

        async function createPDF(images, layout) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 5;
            const padding = 2;
            
            const usableWidth = pageWidth - (margin * 2);
            const usableHeight = pageHeight - (margin * 2);
            
            const cellWidth = usableWidth / layout.cols;
            const cellHeight = usableHeight / layout.rows;
            
            const perPage = layout.cols * layout.rows;
            const totalImages = images.length;
            const totalPages = Math.ceil(totalImages / perPage);
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ±
            images.sort((a, b) => a.name.localeCompare(b.name, 'ar', { numeric: true }));
            
            let pageCount = 0;
            let successfulImages = 0;
            
            for (let i = 0; i < totalImages; i++) {
                const pos = i % perPage;
                const col = pos % layout.cols;
                const row = Math.floor(pos / layout.cols);
                
                if (pos === 0 && i > 0) {
                    doc.addPage();
                }
                
                if (pos === 0) {
                    pageCount++;
                }
                
                const img = images[i];
                const x = margin + (col * cellWidth);
                const y = margin + (row * cellHeight);
                
                try {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØµÙˆØ±Ø©
                    if (!img.data || !img.data.startsWith('data:image')) {
                        console.warn(`Invalid image data for ${img.name}`);
                        continue;
                    }
                    
                    const maxW = cellWidth - (padding * 2);
                    const maxH = cellHeight - (padding * 2);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø£Ùˆ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    const imgWidth = img.width || 400;
                    const imgHeight = img.height || 300;
                    const imgRatio = imgWidth / imgHeight;
                    const cellRatio = maxW / maxH;
                    
                    let drawWidth, drawHeight;
                    
                    if (imgRatio > cellRatio) {
                        drawWidth = maxW;
                        drawHeight = maxW / imgRatio;
                    } else {
                        drawHeight = maxH;
                        drawWidth = maxH * imgRatio;
                    }
                    
                    const drawX = x + padding + (maxW - drawWidth) / 2;
                    const drawY = y + padding + (maxH - drawHeight) / 2;
                    
                    // Ø±Ø³Ù… Ø§Ù„Ø¥Ø·Ø§Ø±
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.2);
                    doc.rect(x + padding, y + padding, cellWidth - padding * 2, cellHeight - padding * 2);
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø©
                    let imgFormat = 'JPEG';
                    if (img.data.includes('data:image/png')) {
                        imgFormat = 'PNG';
                    }
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø©
                    doc.addImage(img.data, imgFormat, drawX, drawY, drawWidth, drawHeight, undefined, 'FAST');
                    successfulImages++;
                    
                } catch (e) {
                    console.warn(`Error adding image ${img.name}:`, e);
                    // Ø±Ø³Ù… placeholder Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ÙØ§Ø´Ù„Ø©
                    doc.setFillColor(240, 240, 240);
                    doc.rect(x + padding, y + padding, cellWidth - padding * 2, cellHeight - padding * 2, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('Ø®Ø·Ø£', x + cellWidth/2, y + cellHeight/2, { align: 'center' });
                }
                
                const percent = ((i + 1) / totalImages) * 100;
                updateProgress(percent, `Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© ${pageCount}/${totalPages}...`);
                document.getElementById('stat-processed').textContent = i + 1;
                document.getElementById('stat-pages').textContent = pageCount;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (i % 3 === 0) {
                    await new Promise(r => setTimeout(r, 10));
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
            doc.setProperties({
                title: document.getElementById('output-name').value || 'Lesson Images',
                creator: `Ù…Ø­ÙˆÙ„ ØµÙˆØ± Ø§Ù„Ø¯Ø±ÙˆØ³ v${__version__} - Mohamed Elherd`,
                author: 'Mohamed Elherd'
            });
            
            generatedPDF = doc;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Blob Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            pdfBlob = doc.output('blob');
            
            updateProgress(100, 'Ø§ÙƒØªÙ…Ù„!');
            
            console.log(`PDF created: ${successfulImages}/${totalImages} images, ${pageCount} pages`);
        }

        function updateProgress(percent, status) {
            const circle = document.getElementById('progress-circle');
            const circumference = 2 * Math.PI * 80;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('progress-status').textContent = status;
        }

        // =====================================================
        // Results
        // =====================================================
        function showResults() {
            goToPage('result');
            
            const images = getFilteredImages();
            const layout = Config.LAYOUTS[layoutOption];
            const perPage = layout.cols * layout.rows;
            const pages = Math.ceil(images.length / perPage);
            
            let removedDuplicates = 0;
            let removedLogos = 0;
            
            if (filterOption === 1) {
                removedDuplicates = analysisResults.duplicates;
                removedLogos = analysisResults.logos;
            } else if (filterOption === 2) {
                removedDuplicates = analysisResults.duplicates;
            }
            
            document.getElementById('result-images').textContent = images.length;
            document.getElementById('result-pages').textContent = pages;
            document.getElementById('result-duplicates').textContent = removedDuplicates;
            document.getElementById('result-logos').textContent = removedLogos;
            
            if (duplicateImages.length > 0 && filterOption <= 2) {
                document.getElementById('duplicates-review').classList.remove('hidden');
                document.getElementById('dup-review-count').textContent = duplicateImages.length;
            } else {
                document.getElementById('duplicates-review').classList.add('hidden');
            }
        }

        // =====================================================
        // PDF Download - Direct without Save As dialog
        // =====================================================
        function downloadPDF() {
            if (!pdfBlob) {
                showSnackbar('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„', 'error');
                return;
            }
            
            const fileName = (document.getElementById('output-name').value || 'output') + '.pdf';
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            
            // ØªÙ†Ø¸ÙŠÙ
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showSnackbar('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function sharePDF() {
            if (!pdfBlob) return;
            
            const fileName = (document.getElementById('output-name').value || 'output') + '.pdf';
            const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
            
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: fileName,
                        text: 'Ù…Ù„Ù PDF Ù…Ù† Ù…Ø­ÙˆÙ„ ØµÙˆØ± Ø§Ù„Ø¯Ø±ÙˆØ³'
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        downloadPDF();
                    }
                }
            } else {
                downloadPDF();
            }
        }

        // =====================================================
        // Duplicates Review
        // =====================================================
        function reviewDuplicates() {
            const modal = document.getElementById('duplicates-modal');
            const grid = document.getElementById('duplicates-grid');
            
            grid.innerHTML = duplicateImages.slice(0, 30).map((img, i) => `
                <div class="relative">
                    <img src="${img.data}" alt="ØªÙƒØ±Ø§Ø± ${i + 1}" class="w-full aspect-square object-cover rounded-lg border border-amber-500/50">
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function closeDuplicatesModal() {
            document.getElementById('duplicates-modal').classList.add('hidden');
        }

        function startNew() {
            allExtractedImages = [];
            validImages = [];
            uniqueImages = [];
            duplicateImages = [];
            logoImages = [];
            selectedFile = null;
            generatedPDF = null;
            pdfBlob = null;
            
            resetFileState();
            goToPage('welcome');
        }

        // =====================================================
        // Utilities
        // =====================================================
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getImageDimensions(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = () => resolve({ width: 400, height: 300 });
                img.src = dataUrl;
            });
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-detail').textContent = '';
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function showLoadingProgress(show) {
            document.getElementById('loading-progress').style.display = show ? 'block' : 'none';
        }

        function updateLoadingBar(percent) {
            document.getElementById('loading-bar').style.width = percent + '%';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showSnackbar(message, type = 'info') {
            const snackbar = document.getElementById('snackbar');
            const icon = document.getElementById('snackbar-icon');
            const msg = document.getElementById('snackbar-message');
            
            const icons = {
                info: 'info',
                success: 'check_circle',
                error: 'error',
                warning: 'warning'
            };
            
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-amber-400'
            };
            
            icon.textContent = icons[type];
            icon.className = `material-icons-round ${colors[type]}`;
            msg.textContent = message;
            
            snackbar.classList.add('show');
            setTimeout(() => snackbar.classList.remove('show'), 3500);
        }
    </script>
</body>
</html>
