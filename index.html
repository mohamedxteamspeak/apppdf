<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PDF Maker Pro">
    <meta name="application-name" content="PDF Maker Pro">
    <meta name="theme-color" content="#0f0f23">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-navbutton-color" content="#0f0f23">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Disable browser features that reveal it's a web app -->
    <meta name="x-apple-disable-message-reformatting" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO -->
    <meta name="description" content="محول صور الدروس إلى PDF احترافي - استخراج الصور من PDF وتحويلها بسهولة">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    
    <title>PDF Maker Pro</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" as="style">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* =====================================================
           CSS VARIABLES & THEMES
           ===================================================== */
        :root {
            /* Colors - Dark Theme */
            --primary: #667eea;
            --primary-light: #7c8ff5;
            --primary-dark: #5a67d8;
            --primary-glow: rgba(102, 126, 234, 0.4);
            --secondary: #764ba2;
            --secondary-light: #8b5cb8;
            --accent: #f093fb;
            --accent-glow: rgba(240, 147, 251, 0.3);
            
            /* Status Colors */
            --success: #10b981;
            --success-light: #34d399;
            --success-glow: rgba(16, 185, 129, 0.4);
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --error: #ef4444;
            --error-light: #f87171;
            --error-glow: rgba(239, 68, 68, 0.4);
            --info: #3b82f6;
            
            /* Background Colors */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --bg-elevated: #2d2d4a;
            --bg-overlay: rgba(15, 15, 35, 0.95);
            
            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-hover: rgba(255, 255, 255, 0.06);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-disabled: #64748b;
            
            /* Border Colors */
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.06);
            --border-focus: var(--primary);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 40px var(--primary-glow);
            --shadow-success: 0 8px 24px var(--success-glow);
            --shadow-error: 0 8px 24px var(--error-glow);
            
            /* Safe Areas */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.35s ease;
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Z-Index Layers */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal: 300;
            --z-overlay: 400;
            --z-toast: 500;
            --z-splash: 1000;
            
            /* Font */
            --font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #e2e8f0;
            --bg-overlay: rgba(248, 250, 252, 0.95);
            
            --glass-bg: rgba(0, 0, 0, 0.02);
            --glass-border: rgba(0, 0, 0, 0.06);
            --glass-hover: rgba(0, 0, 0, 0.04);
            
            --text-primary: #1e293b;
            --text-secondary: #334155;
            --text-muted: #64748b;
            --text-disabled: #94a3b8;
            
            --border-primary: rgba(0, 0, 0, 0.1);
            --border-secondary: rgba(0, 0, 0, 0.06);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.15);
        }

        /* =====================================================
           RESET & BASE STYLES
           ===================================================== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
            overflow: hidden;
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            min-height: -webkit-fill-available;
            overflow: hidden;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* Prevent pull to refresh */
        body.no-pull-refresh {
            overscroll-behavior-y: contain;
        }

        /* Allow text selection in inputs */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
        }

        /* Focus styles */
        :focus {
            outline: none;
        }

        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* =====================================================
           APP CONTAINER
           ===================================================== */
        #app {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* =====================================================
           SPLASH SCREEN
           ===================================================== */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-splash);
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            border-radius: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-glow);
            animation: splash-pulse 2s ease-in-out infinite;
            position: relative;
        }

        .splash-logo::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary), var(--accent), var(--secondary));
            z-index: -1;
            opacity: 0.5;
            filter: blur(15px);
            animation: splash-glow 2s ease-in-out infinite alternate;
        }

        .splash-logo .material-icons-round {
            font-size: 60px;
            color: white;
        }

        .splash-title {
            margin-top: var(--spacing-lg);
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .splash-loader {
            margin-top: var(--spacing-xl);
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .splash-loader-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .splash-status {
            margin-top: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        @keyframes splash-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes splash-glow {
            0% { opacity: 0.3; transform: scale(0.95); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        /* =====================================================
           BACKGROUND PATTERN
           ===================================================== */
        .bg-pattern {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-pattern::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            top: -200px;
            right: -200px;
            animation: bg-float 20s ease-in-out infinite;
        }

        .bg-pattern::after {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(118, 75, 162, 0.15) 0%, transparent 70%);
            bottom: -150px;
            left: -150px;
            animation: bg-float 25s ease-in-out infinite reverse;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            animation: bg-float 15s ease-in-out infinite;
        }

        .bg-orb-1 {
            width: 300px;
            height: 300px;
            background: var(--primary);
            top: 20%;
            left: 10%;
        }

        .bg-orb-2 {
            width: 250px;
            height: 250px;
            background: var(--accent);
            bottom: 30%;
            right: 15%;
            animation-delay: -5s;
        }

        .bg-orb-3 {
            width: 200px;
            height: 200px;
            background: var(--secondary);
            top: 60%;
            left: 50%;
            animation-delay: -10s;
        }

        @keyframes bg-float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.05); }
            50% { transform: translate(-20px, 20px) scale(0.95); }
            75% { transform: translate(20px, 30px) scale(1.02); }
        }

        /* =====================================================
           PAGE TRANSITIONS
           ===================================================== */
        .page {
            display: none;
            position: absolute;
            inset: 0;
            z-index: var(--z-base);
            overflow: hidden;
            padding-top: var(--safe-top);
            background: transparent;
            will-change: transform, opacity;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        /* Slide animations */
        .page.slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .page.slide-out-left {
            animation: slideOutLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .page.slide-in-left {
            animation: slideInLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .page.slide-out-right {
            animation: slideOutRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0.5; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-30%); opacity: 0; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0.5; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(30%); opacity: 0; }
        }

        /* Fade animation */
        .page.fade-in {
            animation: fadeIn 0.35s ease forwards;
        }

        .page.fade-out {
            animation: fadeOut 0.35s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.98); }
        }

        /* =====================================================
           HEADER COMPONENT
           ===================================================== */
        .header {
            position: relative;
            padding: var(--spacing-lg);
            padding-top: calc(var(--spacing-lg) + var(--safe-top));
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            overflow: hidden;
            flex-shrink: 0;
            z-index: 10;
        }

        .header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='20'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .header-compact {
            padding: var(--spacing-md);
            padding-top: calc(var(--spacing-md) + var(--safe-top));
            border-radius: 0;
        }

        .header-transparent {
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-top: var(--spacing-md);
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: var(--spacing-xs);
        }

        /* =====================================================
           BUTTON COMPONENT
           ===================================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            text-decoration: none;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
            -webkit-appearance: none;
            appearance: none;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Button ripple effect */
        .btn .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Primary Button */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: var(--shadow-md), 0 4px 20px var(--primary-glow);
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-lg), 0 6px 30px var(--primary-glow);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: scale(0.97) translateY(0);
        }

        /* Secondary Button */
        .btn-secondary {
            background: var(--glass-bg);
            color: var(--primary);
            border: 2px solid var(--primary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Success Button */
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: var(--shadow-md), var(--shadow-success);
        }

        .btn-success:hover {
            box-shadow: var(--shadow-lg), 0 6px 30px var(--success-glow);
        }

        /* Danger Button */
        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            box-shadow: var(--shadow-md), var(--shadow-error);
        }

        /* Ghost Button */
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: var(--spacing-sm);
        }

        .btn-ghost:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        /* Icon Button */
        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-icon-sm {
            width: 40px;
            height: 40px;
        }

        .btn-icon-lg {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
        }

        /* FAB Button */
        .btn-fab {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            padding: 0;
            box-shadow: var(--shadow-xl), var(--shadow-glow);
        }

        /* Button sizes */
        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.875rem;
            border-radius: var(--radius-md);
        }

        .btn-lg {
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 1.125rem;
            border-radius: var(--radius-xl);
        }

        /* Full width button */
        .btn-block {
            width: 100%;
        }

        /* =====================================================
           CARD COMPONENT
           ===================================================== */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-primary);
            transition: all var(--transition-normal);
        }

        .card-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-color: var(--glass-border);
        }

        .card-gradient {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.08) 0%, 
                rgba(118, 75, 162, 0.08) 100%);
            border-color: rgba(102, 126, 234, 0.15);
        }

        .card-elevated {
            box-shadow: var(--shadow-lg);
        }

        .card-interactive {
            cursor: pointer;
        }

        .card-interactive:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .card-interactive:active {
            transform: translateY(0);
        }

        /* =====================================================
           ICON CIRCLE COMPONENT
           ===================================================== */
        .icon-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            position: relative;
            flex-shrink: 0;
        }

        .icon-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.15);
            animation: pulse-ring 2.5s ease-out infinite;
        }

        .icon-circle-sm {
            width: 64px;
            height: 64px;
        }

        .icon-circle-lg {
            width: 120px;
            height: 120px;
        }

        .icon-circle.animated {
            animation: float 3s ease-in-out infinite;
        }

        .icon-circle.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            box-shadow: var(--shadow-lg), var(--shadow-success);
        }

        .icon-circle.error {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            box-shadow: var(--shadow-lg), var(--shadow-error);
        }

        .icon-circle .material-icons-round {
            color: white;
            font-size: 48px;
        }

        .icon-circle-sm .material-icons-round {
            font-size: 32px;
        }

        .icon-circle-lg .material-icons-round {
            font-size: 60px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* =====================================================
           DROP ZONE COMPONENT
           ===================================================== */
        .drop-zone {
            border: 3px dashed rgba(102, 126, 234, 0.4);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl) var(--spacing-lg);
            text-align: center;
            background: rgba(102, 126, 234, 0.03);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.05) 0%, 
                rgba(118, 75, 162, 0.05) 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .drop-zone:hover::before,
        .drop-zone.dragover::before {
            opacity: 1;
        }

        .drop-zone:active,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
            transform: scale(0.99);
        }

        .drop-zone.processing {
            opacity: 0.6;
            pointer-events: none;
        }

        .drop-zone-icon {
            margin-bottom: var(--spacing-md);
        }

        .drop-zone-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .drop-zone-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* =====================================================
           GALLERY COMPONENT
           ===================================================== */
        .gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
        }

        @media (min-width: 480px) {
            .gallery {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 360px) {
            .gallery {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--bg-secondary);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-normal);
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item.selected {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
        }

        .gallery-item.excluded {
            opacity: 0.4;
            border-color: var(--error);
        }

        .gallery-item .badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-duplicate {
            background: var(--warning);
            color: #000;
        }

        .badge-logo {
            background: var(--error);
            color: white;
        }

        .gallery-item .check {
            position: absolute;
            bottom: 6px;
            left: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .gallery-item.selected .check {
            background: var(--success);
            transform: scale(1.1);
        }

        .gallery-item .check .material-icons-round {
            font-size: 18px;
            color: white;
        }

        .gallery-item .page-num {
            position: absolute;
            top: 6px;
            left: 6px;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            backdrop-filter: blur(4px);
        }

        /* Gallery Empty State */
        .gallery-empty {
            padding: var(--spacing-2xl);
            text-align: center;
            color: var(--text-muted);
        }

        .gallery-empty .material-icons-round {
            font-size: 64px;
            opacity: 0.5;
        }

        /* =====================================================
           LAYOUT SELECTOR
           ===================================================== */
        .layout-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-sm);
        }

        @media (max-width: 360px) {
            .layout-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .layout-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
        }

        .layout-item:hover {
            border-color: var(--border-primary);
        }

        .layout-item.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .layout-preview {
            display: grid;
            gap: 2px;
            aspect-ratio: 3/4;
            padding: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .layout-dot {
            background: rgba(102, 126, 234, 0.4);
            border-radius: 2px;
            transition: background var(--transition-fast);
        }

        .layout-item.selected .layout-dot {
            background: var(--primary);
        }

        .layout-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .layout-item.selected .layout-label {
            color: var(--primary);
        }

        /* =====================================================
           PROGRESS COMPONENT
           ===================================================== */
        .progress-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
        }

        .progress-ring .bg {
            stroke: var(--bg-tertiary);
        }

        .progress-ring .progress {
            stroke: url(#progress-gradient);
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-text {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-value {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* Linear Progress */
        .progress-linear {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-linear-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            animation: progress-shimmer 2s ease infinite;
        }

        @keyframes progress-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* =====================================================
           STATS GRID
           ===================================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
            border: 1px solid var(--border-primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value.success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* =====================================================
           TABS COMPONENT
           ===================================================== */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            flex-shrink: 0;
            background: var(--bg-secondary);
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: inherit;
        }

        .tab:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.2);
        }

        .tab:not(.active) .tab-badge {
            background: var(--bg-elevated);
        }

        /* =====================================================
           INPUT COMPONENT
           ===================================================== */
        .input-group {
            margin-bottom: var(--spacing-md);
        }

        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all var(--transition-fast);
            -webkit-appearance: none;
            appearance: none;
        }

        .input::placeholder {
            color: var(--text-disabled);
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Input with icon */
        .input-wrapper {
            position: relative;
        }

        .input-wrapper .input {
            padding-right: 48px;
        }

        .input-wrapper .input-icon {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* =====================================================
           TOGGLE COMPONENT
           ===================================================== */
        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toggle-item:hover {
            background: var(--bg-tertiary);
        }

        .toggle-item:active {
            background: var(--bg-elevated);
        }

        .toggle-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .toggle-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .toggle-description {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 14px;
            position: relative;
            transition: all var(--transition-normal);
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* =====================================================
           TOAST NOTIFICATION
           ===================================================== */
        .toast-container {
            position: fixed;
            bottom: calc(100px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border: 1px solid var(--border-primary);
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-normal);
            pointer-events: auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            flex-shrink: 0;
        }

        .toast-icon.success { color: var(--success); }
        .toast-icon.error { color: var(--error); }
        .toast-icon.warning { color: var(--warning); }
        .toast-icon.info { color: var(--info); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.875rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
        }

        /* =====================================================
           LOADING OVERLAY
           ===================================================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-overlay);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-overlay);
            gap: var(--spacing-lg);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-sm {
            width: 24px;
            height: 24px;
            border-width: 2px;
        }

        .spinner-lg {
            width: 80px;
            height: 80px;
            border-width: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .loading-progress {
            width: 80%;
            max-width: 300px;
        }

        /* =====================================================
           IMAGE VIEWER (LIGHTBOX)
           ===================================================== */
        .viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: var(--z-modal);
            display: none;
            flex-direction: column;
        }

        .viewer.show {
            display: flex;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            padding-top: calc(var(--spacing-md) + var(--safe-top));
            background: rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }

        .viewer-counter {
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
        }

        .viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
            overflow: hidden;
        }

        .viewer-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius-md);
            touch-action: pinch-zoom;
        }

        .viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all var(--transition-fast);
        }

        .viewer-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .viewer-nav:active {
            transform: translateY(-50%) scale(0.95);
        }

        .viewer-nav.prev { left: var(--spacing-md); }
        .viewer-nav.next { right: var(--spacing-md); }

        .viewer-footer {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            padding-bottom: calc(var(--spacing-md) + var(--safe-bottom));
            background: rgba(0, 0, 0, 0.5);
        }

        /* =====================================================
           ACTION BAR (BOTTOM)
           ===================================================== */
        .action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-md);
            padding-bottom: calc(var(--spacing-md) + var(--safe-bottom));
            background: linear-gradient(to top, 
                var(--bg-primary) 0%, 
                var(--bg-primary) 70%, 
                transparent 100%);
            display: flex;
            gap: var(--spacing-md);
            z-index: var(--z-sticky);
            flex-shrink: 0;
        }

        /* =====================================================
           STEPS INDICATOR
           ===================================================== */
        .steps {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            flex-shrink: 0;
        }

        .step {
            width: 8px;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            transition: all var(--transition-normal);
        }

        .step.active {
            width: 32px;
            background: var(--primary);
        }

        .step.done {
            background: var(--success);
        }

        /* =====================================================
           SCROLL AREA
           ===================================================== */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* =====================================================
           MODAL / BOTTOM SHEET
           ===================================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: var(--spacing-lg);
            padding-bottom: calc(var(--spacing-lg) + var(--safe-bottom));
            z-index: var(--z-modal);
            transform: translateY(100%);
            transition: transform var(--transition-normal);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-overlay.show + .bottom-sheet,
        .bottom-sheet.show {
            transform: translateY(0);
        }

        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            margin: 0 auto var(--spacing-md);
        }

        .bottom-sheet-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        /* =====================================================
           SETTINGS PAGE COMPONENTS
           ===================================================== */
        .settings-section {
            margin-bottom: var(--spacing-lg);
        }

        .settings-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-sm);
        }

        .settings-list {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-primary);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--border-secondary);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--glass-hover);
        }

        .settings-item:active {
            background: var(--bg-tertiary);
        }

        .settings-item-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .settings-item-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .settings-item-text {
            display: flex;
            flex-direction: column;
        }

        .settings-item-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-item-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .settings-item-value {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .settings-item-arrow {
            color: var(--text-muted);
        }

        /* =====================================================
           UTILITY CLASSES
           ===================================================== */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-wrap { flex-wrap: wrap; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .min-h-screen { min-height: 100vh; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 900; }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        
        .text-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background: var(--bg-secondary); }
        .bg-tertiary { background: var(--bg-tertiary); }
        
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-full { border-radius: var(--radius-full); }
        
        /* Spacing */
        .m-0 { margin: 0; }
        .m-1 { margin: var(--spacing-xs); }
        .m-2 { margin: var(--spacing-sm); }
        .m-3 { margin: var(--spacing-md); }
        .m-4 { margin: var(--spacing-lg); }
        .m-5 { margin: var(--spacing-xl); }
        
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-5 { margin-top: var(--spacing-xl); }
        .mt-6 { margin-top: var(--spacing-2xl); }
        
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-5 { margin-bottom: var(--spacing-xl); }
        .mb-6 { margin-bottom: var(--spacing-2xl); }
        
        .p-0 { padding: 0; }
        .p-1 { padding: var(--spacing-xs); }
        .p-2 { padding: var(--spacing-sm); }
        .p-3 { padding: var(--spacing-md); }
        .p-4 { padding: var(--spacing-lg); }
        .p-5 { padding: var(--spacing-xl); }
        .p-6 { padding: var(--spacing-2xl); }
        
        .px-1 { padding-left: var(--spacing-xs); padding-right: var(--spacing-xs); }
        .px-2 { padding-left: var(--spacing-sm); padding-right: var(--spacing-sm); }
        .px-3 { padding-left: var(--spacing-md); padding-right: var(--spacing-md); }
        .px-4 { padding-left: var(--spacing-lg); padding-right: var(--spacing-lg); }
        
        .py-1 { padding-top: var(--spacing-xs); padding-bottom: var(--spacing-xs); }
        .py-2 { padding-top: var(--spacing-sm); padding-bottom: var(--spacing-sm); }
        .py-3 { padding-top: var(--spacing-md); padding-bottom: var(--spacing-md); }
        .py-4 { padding-top: var(--spacing-lg); padding-bottom: var(--spacing-lg); }
        
        .gap-1 { gap: var(--spacing-xs); }
        .gap-2 { gap: var(--spacing-sm); }
        .gap-3 { gap: var(--spacing-md); }
        .gap-4 { gap: var(--spacing-lg); }
        .gap-5 { gap: var(--spacing-xl); }
        
        .space-y-2 > * + * { margin-top: var(--spacing-sm); }
        .space-y-3 > * + * { margin-top: var(--spacing-md); }
        .space-y-4 > * + * { margin-top: var(--spacing-lg); }
        
        .hidden { display: none !important; }
        .invisible { visibility: hidden; }
        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .opacity-100 { opacity: 1; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        
        .inset-0 { inset: 0; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }
        .bottom-0 { bottom: 0; }
        .left-0 { left: 0; }
        
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-50 { z-index: 50; }
        
        .pointer-events-none { pointer-events: none; }
        .cursor-pointer { cursor: pointer; }
        
        .select-none { user-select: none; -webkit-user-select: none; }
        .select-text { user-select: text; -webkit-user-select: text; }
        
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .shadow-xl { box-shadow: var(--shadow-xl); }
        
        .transition { transition: all var(--transition-normal); }
        .transition-fast { transition: all var(--transition-fast); }
        
        /* Padding for action bar */
        .pb-action { padding-bottom: 100px; }
        .pb-safe { padding-bottom: calc(var(--spacing-lg) + var(--safe-bottom)); }

        /* =====================================================
           ANIMATIONS
           ===================================================== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce {
            animation: bounce 0.5s ease;
        }

        @keyframes scale-in {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .scale-in {
            animation: scale-in 0.3s ease forwards;
        }

        /* =====================================================
           REDUCED MOTION
           ===================================================== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="no-pull-refresh">
    <div id="app">
        <!-- Background Pattern -->
        <div class="bg-pattern">
            <div class="bg-orb bg-orb-1"></div>
            <div class="bg-orb bg-orb-2"></div>
            <div class="bg-orb bg-orb-3"></div>
        </div>

        <!-- Splash Screen -->
        <div id="splash-screen">
            <div class="splash-logo">
                <span class="material-icons-round">auto_awesome</span>
            </div>
            <h1 class="splash-title">PDF Maker Pro</h1>
            <div class="splash-loader">
                <div id="splash-progress" class="splash-loader-bar"></div>
            </div>
            <p id="splash-status" class="splash-status">جاري التحميل...</p>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text" class="loading-text">جاري التحميل...</p>
            <div class="loading-progress">
                <div class="progress-linear">
                    <div id="loading-bar" class="progress-linear-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Image Viewer -->
        <div id="viewer" class="viewer">
            <div class="viewer-header">
                <button id="viewer-close" class="btn btn-ghost btn-icon">
                    <span class="material-icons-round">close</span>
                </button>
                <span id="viewer-counter" class="viewer-counter">1 / 10</span>
                <button id="viewer-toggle" class="btn btn-icon" style="background: var(--success);">
                    <span id="viewer-toggle-icon" class="material-icons-round">check</span>
                </button>
            </div>
            <div class="viewer-content">
                <img id="viewer-image" src="" alt="معاينة الصورة">
            </div>
            <button class="viewer-nav prev" id="viewer-prev">
                <span class="material-icons-round">chevron_right</span>
            </button>
            <button class="viewer-nav next" id="viewer-next">
                <span class="material-icons-round">chevron_left</span>
            </button>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal-overlay">
        </div>
        <div id="settings-sheet" class="bottom-sheet">
            <div class="bottom-sheet-handle"></div>
            <h2 class="bottom-sheet-title">الإعدادات</h2>
            
            <div class="settings-section">
                <h3 class="settings-section-title">المظهر</h3>
                <div class="settings-list">
                    <div class="settings-item" id="theme-toggle">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <span class="material-icons-round">dark_mode</span>
                            </div>
                            <div class="settings-item-text">
                                <span class="settings-item-title">الوضع الداكن</span>
                                <span class="settings-item-subtitle">تبديل بين المظهر الفاتح والداكن</span>
                            </div>
                        </div>
                        <div id="theme-switch" class="toggle-switch active"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">التصدير</h3>
                <div class="settings-list">
                    <div class="settings-item" id="auto-download-toggle">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <span class="material-icons-round">download</span>
                            </div>
                            <div class="settings-item-text">
                                <span class="settings-item-title">تحميل تلقائي</span>
                                <span class="settings-item-subtitle">تحميل PDF بعد الإنشاء مباشرة</span>
                            </div>
                        </div>
                        <div id="auto-download-switch" class="toggle-switch active"></div>
                    </div>
                    <div class="settings-item" id="quality-setting">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <span class="material-icons-round">high_quality</span>
                            </div>
                            <div class="settings-item-text">
                                <span class="settings-item-title">جودة الصور</span>
                                <span class="settings-item-subtitle">تحكم في جودة ضغط الصور</span>
                            </div>
                        </div>
                        <span id="quality-value" class="settings-item-value">متوسطة</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">حول التطبيق</h3>
                <div class="settings-list">
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <span class="material-icons-round">info</span>
                            </div>
                            <div class="settings-item-text">
                                <span class="settings-item-title">الإصدار</span>
                                <span class="settings-item-subtitle">PDF Maker Pro</span>
                            </div>
                        </div>
                        <span class="settings-item-value">8.0.0</span>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <span class="material-icons-round">code</span>
                            </div>
                            <div class="settings-item-text">
                                <span class="settings-item-title">المطور</span>
                                <span class="settings-item-subtitle">تصميم وتطوير</span>
                            </div>
                        </div>
                        <span class="settings-item-value">Mohamed Elherd</span>
                    </div>
                </div>
            </div>

            <button id="close-settings" class="btn btn-secondary btn-block mt-4">
                إغلاق
            </button>
        </div>
                <!-- =====================================================
             PAGE: WELCOME
             ===================================================== -->
        <div id="page-welcome" class="page active">
            <div class="scroll-area flex flex-col items-center justify-center p-4">
                <!-- Logo Section -->
                <div class="icon-circle icon-circle-lg animated mb-5">
                    <span class="material-icons-round">auto_awesome</span>
                </div>

                <!-- Title Section -->
                <h1 class="text-3xl font-black text-gradient mb-2">PDF Maker Pro</h1>
                <p class="text-muted text-center mb-2">تحويل الصور إلى PDF احترافي</p>
                <p class="text-xs text-muted mb-5">الإصدار 8.0 • تجربة أصلية</p>

                <!-- Action Buttons -->
                <div class="w-full space-y-3" style="max-width: 340px;">
                    <button id="btn-start-pdf" class="btn btn-primary btn-block btn-lg">
                        <span class="material-icons-round">picture_as_pdf</span>
                        استخراج من PDF
                    </button>
                    <button id="btn-start-images" class="btn btn-secondary btn-block btn-lg">
                        <span class="material-icons-round">photo_library</span>
                        اختيار صور
                    </button>
                </div>

                <!-- Features Card -->
                <div class="card card-gradient mt-5 w-full" style="max-width: 340px;">
                    <div class="flex gap-3 items-start">
                        <div class="icon-circle icon-circle-sm" style="animation: none;">
                            <span class="material-icons-round" style="font-size: 24px;">tips_and_updates</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold mb-2">المميزات الاحترافية</h3>
                            <ul class="text-sm text-muted space-y-2">
                                <li class="flex items-center gap-2">
                                    <span class="material-icons-round text-success" style="font-size: 18px;">check_circle</span>
                                    استخراج ذكي للصور من PDF
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="material-icons-round text-success" style="font-size: 18px;">check_circle</span>
                                    كشف وإزالة التكرارات تلقائياً
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="material-icons-round text-success" style="font-size: 18px;">check_circle</span>
                                    6 تخطيطات مختلفة للصفحة
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="material-icons-round text-success" style="font-size: 18px;">check_circle</span>
                                    مشاركة وحفظ مباشر
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid w-full mt-5" style="max-width: 340px;">
                    <div class="stat-card">
                        <div class="stat-value" id="total-converted">0</div>
                        <div class="stat-label">ملفات محولة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-images">0</div>
                        <div class="stat-label">صور معالجة</div>
                    </div>
                </div>

                <!-- Settings Button -->
                <button id="btn-settings" class="btn btn-ghost mt-4">
                    <span class="material-icons-round">settings</span>
                    الإعدادات
                </button>
            </div>

            <!-- Steps Indicator -->
            <div class="steps">
                <div class="step active"></div>
                <div class="step"></div>
                <div class="step"></div>
                <div class="step"></div>
            </div>
        </div>

        <!-- =====================================================
             PAGE: FILE SELECTION
             ===================================================== -->
        <div id="page-file" class="page">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-row">
                        <button id="btn-back-file" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">arrow_forward</span>
                        </button>
                        <button id="btn-file-help" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">help_outline</span>
                        </button>
                    </div>
                    <h1 id="file-page-title" class="header-title">اختر ملف PDF</h1>
                    <p id="file-page-subtitle" class="header-subtitle">سيتم استخراج الصور تلقائياً</p>
                </div>
            </div>

            <!-- Content -->
            <div class="scroll-area p-4 pb-action" style="margin-top: -20px;">
                <!-- Drop Zone -->
                <div id="drop-zone" class="drop-zone">
                    <div class="drop-zone-icon">
                        <div class="icon-circle icon-circle-sm" style="animation: none;">
                            <span id="drop-zone-icon" class="material-icons-round" style="font-size: 28px;">upload_file</span>
                        </div>
                    </div>
                    <p id="drop-zone-title" class="drop-zone-title">اضغط لاختيار ملف</p>
                    <p id="drop-zone-subtitle" class="drop-zone-subtitle">أو اسحب الملف هنا</p>
                    
                    <!-- File info (hidden initially) -->
                    <div id="file-info" class="hidden mt-3">
                        <div class="flex items-center justify-center gap-2">
                            <span class="material-icons-round text-success">check_circle</span>
                            <span id="file-name" class="font-bold text-success">filename.pdf</span>
                        </div>
                        <p id="file-size" class="text-sm text-muted mt-1">2.5 MB</p>
                    </div>
                </div>

                <!-- Hidden file inputs -->
                <input type="file" id="input-pdf" accept=".pdf,application/pdf" hidden>
                <input type="file" id="input-images" accept="image/*" multiple hidden>

                <!-- Processing Status (hidden initially) -->
                <div id="processing-status" class="hidden mt-4">
                    <div class="card">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="spinner spinner-sm"></div>
                            <span id="processing-text" class="text-sm">جاري استخراج الصور...</span>
                        </div>
                        <div class="progress-linear">
                            <div id="processing-bar" class="progress-linear-bar" style="width: 0%"></div>
                        </div>
                        <p id="processing-detail" class="text-xs text-muted mt-2 text-center">صفحة 1 من 10</p>
                    </div>
                </div>

                <!-- Stats Section (hidden initially) -->
                <div id="stats-section" class="hidden mt-5">
                    <!-- Stats Cards -->
                    <div class="stats-grid mb-4">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">إجمالي الصور</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value success" id="stat-valid">0</div>
                            <div class="stat-label">صور صالحة</div>
                        </div>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="card card-glass mb-4">
                        <h3 class="font-bold text-sm mb-3">تفاصيل التحليل</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-muted">صور مكررة</span>
                                <span id="stat-duplicates" class="text-sm font-bold text-warning">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-muted">شعارات مستبعدة</span>
                                <span id="stat-logos" class="text-sm font-bold text-error">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-muted">وقت المعالجة</span>
                                <span id="stat-time" class="text-sm font-bold">0 ثانية</span>
                            </div>
                        </div>
                    </div>

                    <!-- Continue Button -->
                    <button id="btn-continue-gallery" class="btn btn-primary btn-block">
                        <span class="material-icons-round">visibility</span>
                        معاينة وتخصيص الصور
                    </button>
                </div>

                <!-- Tips Section -->
                <div id="tips-section" class="mt-5">
                    <div class="card card-gradient">
                        <h3 class="font-bold text-sm mb-3 flex items-center gap-2">
                            <span class="material-icons-round" style="color: var(--primary);">lightbulb</span>
                            نصائح مفيدة
                        </h3>
                        <ul class="text-sm text-muted space-y-2">
                            <li>• يدعم التطبيق ملفات PDF بجميع الأحجام</li>
                            <li>• يتم استخراج الصور بأعلى جودة متاحة</li>
                            <li>• الصور المكررة والشعارات تُكتشف تلقائياً</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Steps Indicator -->
            <div class="steps">
                <div class="step done"></div>
                <div class="step active"></div>
                <div class="step"></div>
                <div class="step"></div>
            </div>
        </div>

        <!-- =====================================================
             PAGE: GALLERY
             ===================================================== -->
        <div id="page-gallery" class="page">
            <!-- Header -->
            <div class="header header-compact">
                <div class="header-content">
                    <div class="header-row">
                        <button id="btn-back-gallery" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">arrow_forward</span>
                        </button>
                        <span id="selection-count" class="text-sm font-bold" style="color: white;">0 صورة محددة</span>
                        <button id="btn-gallery-menu" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">more_vert</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-filter="all">
                    الكل
                    <span id="count-all" class="tab-badge">0</span>
                </button>
                <button class="tab" data-filter="valid">
                    صالحة
                    <span id="count-valid" class="tab-badge">0</span>
                </button>
                <button class="tab" data-filter="duplicate">
                    مكررة
                    <span id="count-duplicate" class="tab-badge">0</span>
                </button>
                <button class="tab" data-filter="logo">
                    شعارات
                    <span id="count-logo" class="tab-badge">0</span>
                </button>
            </div>

            <!-- Gallery Content -->
            <div class="scroll-area pb-action">
                <div id="gallery-grid" class="gallery">
                    <!-- Gallery items will be inserted here -->
                </div>
                
                <!-- Empty State -->
                <div id="gallery-empty" class="gallery-empty hidden">
                    <span class="material-icons-round">image_not_supported</span>
                    <p class="mt-3 font-bold">لا توجد صور</p>
                    <p class="text-sm mt-1">لا توجد صور في هذا التصنيف</p>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <button id="btn-select-all" class="btn btn-secondary flex-1">
                    <span class="material-icons-round">select_all</span>
                    تحديد الكل
                </button>
                <button id="btn-continue-settings" class="btn btn-primary flex-1">
                    التالي
                    <span class="material-icons-round">arrow_back</span>
                </button>
            </div>
        </div>

        <!-- =====================================================
             PAGE: PDF SETTINGS
             ===================================================== -->
        <div id="page-settings" class="page">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-row">
                        <button id="btn-back-settings" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">arrow_forward</span>
                        </button>
                        <button id="btn-preview-settings" class="btn btn-ghost btn-icon" style="color: white;">
                            <span class="material-icons-round">preview</span>
                        </button>
                    </div>
                    <h1 class="header-title">إعدادات PDF</h1>
                    <p class="header-subtitle">تخصيص شكل الملف النهائي</p>
                </div>
            </div>

            <!-- Content -->
            <div class="scroll-area p-4 pb-action" style="margin-top: -20px;">
                <!-- Layout Selection -->
                <div class="settings-section">
                    <h3 class="settings-section-title">تخطيط الصفحة</h3>
                    <p class="text-sm text-muted mb-3 px-2">اختر عدد الصور في كل صفحة</p>
                    <div id="layout-grid" class="layout-grid">
                        <!-- Layout items will be inserted here -->
                    </div>
                </div>

                <!-- Page Count Preview -->
                <div class="card mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-muted text-sm">عدد الصفحات المتوقع</span>
                            <p class="text-xs text-muted mt-1">بناءً على التخطيط المختار</p>
                        </div>
                        <div class="text-center">
                            <span id="expected-pages" class="text-3xl font-black text-gradient">0</span>
                            <p class="text-xs text-muted">صفحة</p>
                        </div>
                    </div>
                </div>

                <!-- File Name -->
                <div class="settings-section">
                    <h3 class="settings-section-title">اسم الملف</h3>
                    <div class="input-wrapper">
                        <input type="text" id="pdf-filename" class="input" placeholder="اسم_الملف">
                        <span class="input-icon material-icons-round">edit</span>
                    </div>
                </div>

                <!-- Options -->
                <div class="settings-section">
                    <h3 class="settings-section-title">خيارات إضافية</h3>
                    <div class="space-y-2">
                        <div class="toggle-item" id="toggle-auto-download">
                            <div class="toggle-content">
                                <span class="toggle-title">تحميل تلقائي</span>
                                <span class="toggle-description">بدء التحميل فور إنشاء الملف</span>
                            </div>
                            <div id="switch-auto-download" class="toggle-switch active"></div>
                        </div>
                        <div class="toggle-item" id="toggle-add-border">
                            <div class="toggle-content">
                                <span class="toggle-title">إضافة إطار</span>
                                <span class="toggle-description">إطار خفيف حول كل صورة</span>
                            </div>
                            <div id="switch-add-border" class="toggle-switch active"></div>
                        </div>
                        <div class="toggle-item" id="toggle-compress">
                            <div class="toggle-content">
                                <span class="toggle-title">ضغط الملف</span>
                                <span class="toggle-description">تقليل حجم الملف النهائي</span>
                            </div>
                            <div id="switch-compress" class="toggle-switch active"></div>
                        </div>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="card card-gradient">
                    <h3 class="font-bold text-sm mb-3 flex items-center gap-2">
                        <span class="material-icons-round" style="color: var(--primary);">summarize</span>
                        ملخص العملية
                    </h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-muted">الصور المحددة</span>
                            <span id="summary-selected" class="text-sm font-bold text-success">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted">الصور المستبعدة</span>
                            <span id="summary-excluded" class="text-sm font-bold text-muted">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted">التخطيط</span>
                            <span id="summary-layout" class="text-sm font-bold">6 صور/صفحة</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted">الحجم التقريبي</span>
                            <span id="summary-size" class="text-sm font-bold">~2 MB</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <button id="btn-create-pdf" class="btn btn-success btn-block btn-lg">
                    <span class="material-icons-round">picture_as_pdf</span>
                    إنشاء PDF
                </button>
            </div>
        </div>

        <!-- =====================================================
             PAGE: PROCESSING
             ===================================================== -->
        <div id="page-processing" class="page">
            <div class="scroll-area flex flex-col items-center justify-center p-4">
                <!-- Progress Circle -->
                <div class="progress-container mb-5">
                    <svg class="progress-ring" width="200" height="200" viewBox="0 0 200 200">
                        <defs>
                            <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#667eea"/>
                                <stop offset="50%" stop-color="#764ba2"/>
                                <stop offset="100%" stop-color="#f093fb"/>
                            </linearGradient>
                        </defs>
                        <circle class="bg" cx="100" cy="100" r="88"/>
                        <circle class="progress" cx="100" cy="100" r="88" 
                                stroke-dasharray="553" stroke-dashoffset="553" 
                                id="progress-circle"/>
                    </svg>
                    <div class="progress-text">
                        <span id="progress-percent" class="progress-value">0%</span>
                        <span id="progress-status" class="progress-label">جاري الإعداد...</span>
                    </div>
                </div>

                <!-- Title -->
                <h2 class="text-xl font-bold mb-2">جاري إنشاء PDF</h2>
                <p class="text-muted text-sm text-center mb-5">يرجى الانتظار حتى اكتمال العملية</p>

                <!-- Live Stats -->
                <div class="stats-grid w-full" style="max-width: 300px;">
                    <div class="stat-card">
                        <div id="live-images" class="stat-value text-xl">0</div>
                        <div class="stat-label">صورة مضافة</div>
                    </div>
                    <div class="stat-card">
                        <div id="live-pages" class="stat-value text-xl">0</div>
                        <div class="stat-label">صفحة مكتملة</div>
                    </div>
                </div>

                <!-- Current Action -->
                <div class="card card-glass w-full mt-5" style="max-width: 300px;">
                    <div class="flex items-center gap-3">
                        <div class="spinner spinner-sm"></div>
                        <span id="current-action" class="text-sm text-muted">تحضير الصور...</span>
                    </div>
                </div>

                <!-- Tips while waiting -->
                <div class="mt-5 text-center">
                    <p class="text-xs text-muted">💡 نصيحة: يمكنك مشاركة الملف مباشرة بعد الإنشاء</p>
                </div>
            </div>
        </div>

        <!-- =====================================================
             PAGE: RESULT
             ===================================================== -->
        <div id="page-result" class="page">
            <div class="scroll-area p-4 pb-safe">
                <!-- Success Icon -->
                <div class="text-center mb-5 mt-4">
                    <div class="icon-circle icon-circle-lg success animated mx-auto">
                        <span class="material-icons-round">check_circle</span>
                    </div>
                </div>

                <!-- Title -->
                <div class="text-center mb-5">
                    <h1 class="text-2xl font-black mb-2">تم بنجاح! 🎉</h1>
                    <p class="text-muted">ملف PDF جاهز للتحميل والمشاركة</p>
                </div>

                <!-- Result Stats -->
                <div class="stats-grid mb-5">
                    <div class="stat-card">
                        <div id="result-images" class="stat-value">0</div>
                        <div class="stat-label">صورة</div>
                    </div>
                    <div class="stat-card">
                        <div id="result-pages" class="stat-value">0</div>
                        <div class="stat-label">صفحة</div>
                    </div>
                </div>

                <!-- File Info Card -->
                <div class="card mb-5">
                    <div class="flex items-center gap-3">
                        <div class="icon-circle icon-circle-sm" style="animation: none; background: var(--bg-tertiary);">
                            <span class="material-icons-round" style="font-size: 24px; color: var(--error);">picture_as_pdf</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="result-filename" class="font-bold truncate">document.pdf</p>
                            <p id="result-filesize" class="text-sm text-muted">2.5 MB</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button id="btn-download" class="btn btn-primary btn-block btn-lg">
                        <span class="material-icons-round">download</span>
                        تحميل PDF
                    </button>

                    <button id="btn-share" class="btn btn-secondary btn-block">
                        <span class="material-icons-round">share</span>
                        مشاركة
                    </button>

                    <button id="btn-preview" class="btn btn-secondary btn-block" style="border-color: var(--success); color: var(--success);">
                        <span class="material-icons-round">visibility</span>
                        معاينة في المتصفح
                    </button>

                    <button id="btn-new-conversion" class="btn btn-ghost btn-block">
                        <span class="material-icons-round">add</span>
                        تحويل جديد
                    </button>
                </div>

                <!-- Rate Card -->
                <div class="card card-gradient mt-5">
                    <div class="text-center">
                        <p class="font-bold mb-2">هل أعجبك التطبيق؟</p>
                        <p class="text-sm text-muted mb-3">ساعدنا بتقييمك ومشاركتك</p>
                        <div class="flex justify-center gap-2">
                            <button class="btn btn-ghost btn-icon-sm">⭐</button>
                            <button class="btn btn-ghost btn-icon-sm">⭐</button>
                            <button class="btn btn-ghost btn-icon-sm">⭐</button>
                            <button class="btn btn-ghost btn-icon-sm">⭐</button>
                            <button class="btn btn-ghost btn-icon-sm">⭐</button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center mt-5">
                    <p class="text-xs text-muted">
                        PDF Maker Pro v8.0<br>
                        صُنع بـ ❤️ بواسطة Mohamed Elherd
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- =====================================================
         JAVASCRIPT
         ===================================================== -->
    <script>
        /**
         * PDF Maker Pro v8.0
         * Professional PDF Converter
         * By Mohamed Elherd
         */

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const CONFIG = {
            version: '8.0.0',
            author: 'Mohamed Elherd',
            
            // Image processing
            minImageSize: 50,           // Minimum image dimension
            maxLogoSize: 30000,         // Max bytes for logo detection
            logoMaxDimension: 120,      // Max dimension for logo
            hashSize: 8,                // Perceptual hash size
            similarityThreshold: 0.88,  // Duplicate detection threshold
            maxImageDimension: 600,     // Max image size for processing
            jpegQuality: 0.65,          // JPEG compression quality
            
            // PDF settings
            pageWidth: 210,             // A4 width in mm
            pageHeight: 297,            // A4 height in mm
            pageMargin: 4,              // Page margin in mm
            cellPadding: 2,             // Cell padding in mm
            
            // Layouts
            layouts: {
                1: { cols: 1, rows: 1, name: '1 صورة' },
                2: { cols: 1, rows: 2, name: '2 صور' },
                4: { cols: 2, rows: 2, name: '4 صور' },
                6: { cols: 2, rows: 3, name: '6 صور' },
                9: { cols: 3, rows: 3, name: '9 صور' },
                12: { cols: 3, rows: 4, name: '12 صورة' },
                16: { cols: 4, rows: 4, name: '16 صورة' }
            },
            
            // Animation durations
            pageTransitionDuration: 400,
            toastDuration: 3500,
            splashMinDuration: 1500,
            
            // Storage keys
            storageKeys: {
                theme: 'pdf-maker-theme',
                stats: 'pdf-maker-stats',
                settings: 'pdf-maker-settings'
            }
        };

        // =====================================================
        // STATE MANAGEMENT
        // =====================================================
        const State = {
            // App state
            currentPage: 'welcome',
            previousPage: null,
            isProcessing: false,
            
            // Mode
            mode: 'pdf', // 'pdf' or 'images'
            
            // File data
            fileName: '',
            fileSize: 0,
            
            // Images
            images: [],
            selectedIds: new Set(),
            categories: {
                valid: [],
                duplicate: [],
                logo: []
            },
            
            // Filter
            currentFilter: 'all',
            
            // Viewer
            viewerIndex: 0,
            viewerImages: [],
            
            // Settings
            layout: 6,
            autoDownload: true,
            addBorder: true,
            compress: true,
            outputFilename: 'document',
            
            // Result
            pdfBlob: null,
            resultStats: {
                images: 0,
                pages: 0,
                size: 0
            },
            
            // Theme
            darkMode: true,
            
            // Stats
            totalConverted: 0,
            totalImages: 0
        };

        // =====================================================
        // DOM ELEMENTS CACHE
        // =====================================================
        const DOM = {};

        function cacheDOM() {
            // Splash
            DOM.splashScreen = document.getElementById('splash-screen');
            DOM.splashProgress = document.getElementById('splash-progress');
            DOM.splashStatus = document.getElementById('splash-status');
            
            // Loading
            DOM.loadingOverlay = document.getElementById('loading-overlay');
            DOM.loadingText = document.getElementById('loading-text');
            DOM.loadingBar = document.getElementById('loading-bar');
            
            // Toast
            DOM.toastContainer = document.getElementById('toast-container');
            
            // Viewer
            DOM.viewer = document.getElementById('viewer');
            DOM.viewerImage = document.getElementById('viewer-image');
            DOM.viewerCounter = document.getElementById('viewer-counter');
            DOM.viewerToggle = document.getElementById('viewer-toggle');
            DOM.viewerToggleIcon = document.getElementById('viewer-toggle-icon');
            
            // Settings Modal
            DOM.settingsModal = document.getElementById('settings-modal');
            DOM.settingsSheet = document.getElementById('settings-sheet');
            
            // Pages
            DOM.pages = {
                welcome: document.getElementById('page-welcome'),
                file: document.getElementById('page-file'),
                gallery: document.getElementById('page-gallery'),
                settings: document.getElementById('page-settings'),
                processing: document.getElementById('page-processing'),
                result: document.getElementById('page-result')
            };
            
            // Welcome page
            DOM.btnStartPdf = document.getElementById('btn-start-pdf');
            DOM.btnStartImages = document.getElementById('btn-start-images');
            DOM.btnSettings = document.getElementById('btn-settings');
            DOM.totalConverted = document.getElementById('total-converted');
            DOM.totalImages = document.getElementById('total-images');
            
            // File page
            DOM.btnBackFile = document.getElementById('btn-back-file');
            DOM.dropZone = document.getElementById('drop-zone');
            DOM.dropZoneIcon = document.getElementById('drop-zone-icon');
            DOM.dropZoneTitle = document.getElementById('drop-zone-title');
            DOM.dropZoneSubtitle = document.getElementById('drop-zone-subtitle');
            DOM.fileInfo = document.getElementById('file-info');
            DOM.filePageTitle = document.getElementById('file-page-title');
            DOM.filePageSubtitle = document.getElementById('file-page-subtitle');
            DOM.inputPdf = document.getElementById('input-pdf');
            DOM.inputImages = document.getElementById('input-images');
            DOM.processingStatus = document.getElementById('processing-status');
            DOM.processingText = document.getElementById('processing-text');
            DOM.processingBar = document.getElementById('processing-bar');
            DOM.processingDetail = document.getElementById('processing-detail');
            DOM.statsSection = document.getElementById('stats-section');
            DOM.statTotal = document.getElementById('stat-total');
            DOM.statValid = document.getElementById('stat-valid');
            DOM.statDuplicates = document.getElementById('stat-duplicates');
            DOM.statLogos = document.getElementById('stat-logos');
            DOM.statTime = document.getElementById('stat-time');
            DOM.btnContinueGallery = document.getElementById('btn-continue-gallery');
            DOM.tipsSection = document.getElementById('tips-section');
            
            // Gallery page
            DOM.btnBackGallery = document.getElementById('btn-back-gallery');
            DOM.selectionCount = document.getElementById('selection-count');
            DOM.tabs = document.querySelectorAll('.tab[data-filter]');
            DOM.galleryGrid = document.getElementById('gallery-grid');
            DOM.galleryEmpty = document.getElementById('gallery-empty');
            DOM.countAll = document.getElementById('count-all');
            DOM.countValid = document.getElementById('count-valid');
            DOM.countDuplicate = document.getElementById('count-duplicate');
            DOM.countLogo = document.getElementById('count-logo');
            DOM.btnSelectAll = document.getElementById('btn-select-all');
            DOM.btnContinueSettings = document.getElementById('btn-continue-settings');
            
            // Settings page
            DOM.btnBackSettings = document.getElementById('btn-back-settings');
            DOM.layoutGrid = document.getElementById('layout-grid');
            DOM.expectedPages = document.getElementById('expected-pages');
            DOM.pdfFilename = document.getElementById('pdf-filename');
            DOM.toggleAutoDownload = document.getElementById('toggle-auto-download');
            DOM.switchAutoDownload = document.getElementById('switch-auto-download');
            DOM.toggleAddBorder = document.getElementById('toggle-add-border');
            DOM.switchAddBorder = document.getElementById('switch-add-border');
            DOM.toggleCompress = document.getElementById('toggle-compress');
            DOM.switchCompress = document.getElementById('switch-compress');
            DOM.summarySelected = document.getElementById('summary-selected');
            DOM.summaryExcluded = document.getElementById('summary-excluded');
            DOM.summaryLayout = document.getElementById('summary-layout');
            DOM.summarySize = document.getElementById('summary-size');
            DOM.btnCreatePdf = document.getElementById('btn-create-pdf');
            
            // Processing page
            DOM.progressCircle = document.getElementById('progress-circle');
            DOM.progressPercent = document.getElementById('progress-percent');
            DOM.progressStatus = document.getElementById('progress-status');
            DOM.liveImages = document.getElementById('live-images');
            DOM.livePages = document.getElementById('live-pages');
            DOM.currentAction = document.getElementById('current-action');
            
            // Result page
            DOM.resultImages = document.getElementById('result-images');
            DOM.resultPages = document.getElementById('result-pages');
            DOM.resultFilename = document.getElementById('result-filename');
            DOM.resultFilesize = document.getElementById('result-filesize');
            DOM.btnDownload = document.getElementById('btn-download');
            DOM.btnShare = document.getElementById('btn-share');
            DOM.btnPreview = document.getElementById('btn-preview');
            DOM.btnNewConversion = document.getElementById('btn-new-conversion');
            
            // Settings modal
            DOM.themeToggle = document.getElementById('theme-toggle');
            DOM.themeSwitch = document.getElementById('theme-switch');
            DOM.closeSettings = document.getElementById('close-settings');
        }

        // =====================================================
        // UTILITIES
        // =====================================================
        const Utils = {
            // Format file size
            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(1) + ' MB';
            },
            
            // Format time
            formatTime(seconds) {
                if (seconds < 1) return 'أقل من ثانية';
                if (seconds < 60) return Math.round(seconds) + ' ثانية';
                const mins = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${mins} دقيقة ${secs} ثانية`;
            },
            
            // Delay promise
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },
            
            // Read file as data URL
            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            
            // Read file as array buffer
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            },
            
            // Generate unique ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            // Debounce function
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // Throttle function
            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // Check if device is mobile
            isMobile() {
                return /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                    || window.innerWidth < 768;
            },
            
            // Check if iOS
            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent);
            },
            
            // Check if standalone mode (PWA)
            isStandalone() {
                return window.matchMedia('(display-mode: standalone)').matches 
                    || window.navigator.standalone === true;
            },
            
            // Vibrate (haptic feedback)
            vibrate(pattern = 10) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            },
            
            // Save to local storage
            saveToStorage(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn('Storage save failed:', e);
                }
            },
            
            // Load from local storage
            loadFromStorage(key, defaultValue = null) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) {
                    console.warn('Storage load failed:', e);
                    return defaultValue;
                }
            }
        };

        // =====================================================
        // TOAST NOTIFICATIONS
        // =====================================================
        const Toast = {
            queue: [],
            isShowing: false,
            
            show(message, type = 'info', duration = CONFIG.toastDuration) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                
                const icons = {
                    info: 'info',
                    success: 'check_circle',
                    error: 'error',
                    warning: 'warning'
                };
                
                toast.innerHTML = `
                    <span class="material-icons-round toast-icon ${type}">${icons[type] || 'info'}</span>
                    <span class="toast-content">${message}</span>
                `;
                
                DOM.toastContainer.appendChild(toast);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });
                
                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
                
                // Haptic feedback
                if (type === 'success') Utils.vibrate(10);
                if (type === 'error') Utils.vibrate([20, 50, 20]);
            },
            
            success(message) {
                this.show(message, 'success');
            },
            
            error(message) {
                this.show(message, 'error');
            },
            
            warning(message) {
                this.show(message, 'warning');
            },
            
            info(message) {
                this.show(message, 'info');
            }
        };

        // =====================================================
        // LOADING OVERLAY
        // =====================================================
        const Loading = {
            show(text = 'جاري التحميل...', showProgress = false) {
                DOM.loadingText.textContent = text;
                DOM.loadingBar.parentElement.style.display = showProgress ? 'block' : 'none';
                DOM.loadingBar.style.width = '0%';
                DOM.loadingOverlay.classList.add('show');
            },
            
            updateText(text) {
                DOM.loadingText.textContent = text;
            },
            
            updateProgress(percent) {
                DOM.loadingBar.style.width = percent + '%';
            },
            
            hide() {
                DOM.loadingOverlay.classList.remove('show');
            }
        };

        // =====================================================
        // NAVIGATION
        // =====================================================
        const Navigation = {
            history: [],
            
            goTo(pageName, direction = 'forward') {
                if (State.currentPage === pageName) return;
                if (State.isProcessing && pageName !== 'processing') return;
                
                const currentPage = DOM.pages[State.currentPage];
                const nextPage = DOM.pages[pageName];
                
                if (!currentPage || !nextPage) return;
                
                // Save to history
                if (direction === 'forward') {
                    this.history.push(State.currentPage);
                }
                
                // Animation classes
                const animOut = direction === 'forward' ? 'slide-out-left' : 'slide-out-right';
                const animIn = direction === 'forward' ? 'slide-in-right' : 'slide-in-left';
                
                // Animate out current page
                currentPage.classList.add(animOut);
                
                // Show and animate in next page
                nextPage.classList.add('active', animIn);
                
                // Cleanup after animation
                setTimeout(() => {
                    currentPage.classList.remove('active', animOut);
                    nextPage.classList.remove(animIn);
                    
                    State.previousPage = State.currentPage;
                    State.currentPage = pageName;
                    
                    // Page-specific actions
                    this.onPageEnter(pageName);
                }, CONFIG.pageTransitionDuration);
                
                // Update browser history
                history.pushState({ page: pageName }, '', '');
            },
            
            goBack() {
                if (this.history.length > 0) {
                    const previousPage = this.history.pop();
                    this.goTo(previousPage, 'back');
                }
            },
            
            onPageEnter(pageName) {
                switch (pageName) {
                    case 'gallery':
                        Gallery.render();
                        Gallery.updateSelectionCount();
                        break;
                    case 'settings':
                        Settings.updateSummary();
                        break;
                }
            }
        };

        // =====================================================
        // SPLASH SCREEN
        // =====================================================
        const Splash = {
            async show() {
                let progress = 0;
                const startTime = Date.now();
                
                // Simulate loading
                const updateProgress = async (value, text) => {
                    progress = value;
                    DOM.splashProgress.style.width = value + '%';
                    DOM.splashStatus.textContent = text;
                    await Utils.delay(100);
                };
                
                await updateProgress(20, 'تحميل المكتبات...');
                await updateProgress(40, 'إعداد الواجهة...');
                await updateProgress(60, 'تحميل الإعدادات...');
                
                // Load saved settings
                this.loadSettings();
                
                await updateProgress(80, 'جاري التهيئة...');
                await updateProgress(100, 'جاهز!');
                
                // Ensure minimum splash duration
                const elapsed = Date.now() - startTime;
                if (elapsed < CONFIG.splashMinDuration) {
                    await Utils.delay(CONFIG.splashMinDuration - elapsed);
                }
                
                // Hide splash
                DOM.splashScreen.classList.add('hidden');
            },
            
            loadSettings() {
                // Load theme
                const savedTheme = Utils.loadFromStorage(CONFIG.storageKeys.theme, 'dark');
                State.darkMode = savedTheme === 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                // Load stats
                const savedStats = Utils.loadFromStorage(CONFIG.storageKeys.stats, {
                    totalConverted: 0,
                    totalImages: 0
                });
                State.totalConverted = savedStats.totalConverted;
                State.totalImages = savedStats.totalImages;
                
                // Load settings
                const savedSettings = Utils.loadFromStorage(CONFIG.storageKeys.settings, {});
                if (savedSettings.autoDownload !== undefined) State.autoDownload = savedSettings.autoDownload;
                if (savedSettings.addBorder !== undefined) State.addBorder = savedSettings.addBorder;
                if (savedSettings.compress !== undefined) State.compress = savedSettings.compress;
                if (savedSettings.layout !== undefined) State.layout = savedSettings.layout;
            }
        };

        // =====================================================
        // IMAGE VIEWER
        // =====================================================
        const Viewer = {
            isOpen: false,
            touchStartX: 0,
            
            open(index, images = null) {
                if (images) {
                    State.viewerImages = images;
                }
                
                if (index < 0 || index >= State.viewerImages.length) return;
                
                State.viewerIndex = index;
                this.update();
                DOM.viewer.classList.add('show');
                this.isOpen = true;
                document.body.style.overflow = 'hidden';
            },
            
            close() {
                DOM.viewer.classList.remove('show');
                this.isOpen = false;
                document.body.style.overflow = '';
                
                // Refresh gallery if needed
                if (State.currentPage === 'gallery') {
                    Gallery.render();
                }
            },
            
            update() {
                const image = State.viewerImages[State.viewerIndex];
                if (!image) return;
                
                DOM.viewerImage.src = image.data;
                DOM.viewerCounter.textContent = `${State.viewerIndex + 1} / ${State.viewerImages.length}`;
                
                const isSelected = State.selectedIds.has(image.id);
                DOM.viewerToggle.style.background = isSelected ? 'var(--success)' : 'var(--error)';
                DOM.viewerToggleIcon.textContent = isSelected ? 'check' : 'close';
            },
            
            prev() {
                if (State.viewerIndex > 0) {
                    State.viewerIndex--;
                    this.update();
                }
            },
            
            next() {
                if (State.viewerIndex < State.viewerImages.length - 1) {
                    State.viewerIndex++;
                    this.update();
                }
            },
            
            toggleSelection() {
                const image = State.viewerImages[State.viewerIndex];
                if (!image) return;
                
                if (State.selectedIds.has(image.id)) {
                    State.selectedIds.delete(image.id);
                } else {
                    State.selectedIds.add(image.id);
                }
                
                this.update();
                Gallery.updateSelectionCount();
                Utils.vibrate(10);
            },
            
            handleSwipe(startX, endX) {
                const diff = startX - endX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        this.next();
                    } else {
                        this.prev();
                    }
                }
            }
        };

        // =====================================================
        // GALLERY
        // =====================================================
        const Gallery = {
            render() {
                const filter = State.currentFilter;
                let images;
                
                if (filter === 'all') {
                    images = State.images;
                } else {
                    const categoryIds = State.categories[filter] || [];
                    images = State.images.filter(img => categoryIds.includes(img.id));
                }
                
                // Update counts
                DOM.countAll.textContent = State.images.length;
                DOM.countValid.textContent = State.categories.valid.length;
                DOM.countDuplicate.textContent = State.categories.duplicate.length;
                DOM.countLogo.textContent = State.categories.logo.length;
                
                // Show empty state if needed
                if (images.length === 0) {
                    DOM.galleryGrid.innerHTML = '';
                    DOM.galleryEmpty.classList.remove('hidden');
                    return;
                }
                
                DOM.galleryEmpty.classList.add('hidden');
                
                // Render images
                DOM.galleryGrid.innerHTML = images.map((img, idx) => {
                    const isSelected = State.selectedIds.has(img.id);
                    const category = img.category;
                    
                    let badgeHtml = '';
                    if (category === 'duplicate') {
                        badgeHtml = '<span class="badge badge-duplicate">مكرر</span>';
                    } else if (category === 'logo') {
                        badgeHtml = '<span class="badge badge-logo">شعار</span>';
                    }
                    
                    return `
                        <div class="gallery-item ${isSelected ? 'selected' : 'excluded'}" 
                             data-id="${img.id}" 
                             data-index="${idx}">
                            <img src="${img.data}" loading="lazy" alt="صورة ${idx + 1}">
                            ${img.page ? `<span class="page-num">ص${img.page}</span>` : ''}
                            ${badgeHtml}
                            <div class="check">
                                <span class="material-icons-round">${isSelected ? 'check' : ''}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners
                this.attachEventListeners(images);
            },
            
            attachEventListeners(images) {
                const items = DOM.galleryGrid.querySelectorAll('.gallery-item');
                
                items.forEach(item => {
                    const id = item.dataset.id;
                    const index = parseInt(item.dataset.index);
                    
                    // Click to toggle
                    item.addEventListener('click', () => {
                        this.toggleSelection(id);
                    });
                    
                    // Long press to view
                    let pressTimer;
                    
                    item.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            Utils.vibrate(20);
                            Viewer.open(index, images);
                        }, 400);
                    }, { passive: true });
                    
                    item.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                    
                    item.addEventListener('touchmove', () => {
                        clearTimeout(pressTimer);
                    });
                });
            },
            
            toggleSelection(id) {
                if (State.selectedIds.has(id)) {
                    State.selectedIds.delete(id);
                } else {
                    State.selectedIds.add(id);
                }
                
                // Update UI
                const item = DOM.galleryGrid.querySelector(`[data-id="${id}"]`);
                if (item) {
                    const isSelected = State.selectedIds.has(id);
                    item.classList.toggle('selected', isSelected);
                    item.classList.toggle('excluded', !isSelected);
                    item.querySelector('.check .material-icons-round').textContent = isSelected ? 'check' : '';
                }
                
                this.updateSelectionCount();
                Utils.vibrate(10);
            },
            
            selectAll() {
                const filter = State.currentFilter;
                let ids;
                
                if (filter === 'all') {
                    ids = State.images.map(img => img.id);
                } else {
                    ids = State.categories[filter] || [];
                }
                
                const allSelected = ids.every(id => State.selectedIds.has(id));
                
                if (allSelected) {
                    ids.forEach(id => State.selectedIds.delete(id));
                } else {
                    ids.forEach(id => State.selectedIds.add(id));
                }
                
                this.render();
                this.updateSelectionCount();
                Utils.vibrate(10);
            },
            
            updateSelectionCount() {
                DOM.selectionCount.textContent = `${State.selectedIds.size} صورة محددة`;
            },
            
            setFilter(filter) {
                State.currentFilter = filter;
                
                // Update tabs
                DOM.tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.filter === filter);
                });
                
                this.render();
            }
        };

        // =====================================================
        // SETTINGS PAGE
        // =====================================================
        const Settings = {
            initLayouts() {
                DOM.layoutGrid.innerHTML = Object.entries(CONFIG.layouts).map(([count, layout]) => {
                    const isSelected = parseInt(count) === State.layout;
                    const dots = Math.min(layout.cols * layout.rows, 9);
                    
                    return `
                        <div class="layout-item ${isSelected ? 'selected' : ''}" data-layout="${count}">
                            <div class="layout-preview" style="grid-template-columns: repeat(${layout.cols}, 1fr);">
                                ${Array(dots).fill('<div class="layout-dot"></div>').join('')}
                            </div>
                            <span class="layout-label">${count}</span>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners
                DOM.layoutGrid.querySelectorAll('.layout-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const layout = parseInt(item.dataset.layout);
                        this.setLayout(layout);
                    });
                });
            },
            
            setLayout(layout) {
                State.layout = layout;
                
                // Update UI
                DOM.layoutGrid.querySelectorAll('.layout-item').forEach(item => {
                    item.classList.toggle('selected', parseInt(item.dataset.layout) === layout);
                });
                
                this.updateSummary();
                this.saveSettings();
            },
            
            updateSummary() {
                const layout = CONFIG.layouts[State.layout];
                const imagesPerPage = layout.cols * layout.rows;
                const totalSelected = State.selectedIds.size;
                const totalExcluded = State.images.length - totalSelected;
                const expectedPages = Math.ceil(totalSelected / imagesPerPage);
                const estimatedSize = Math.round(totalSelected * 0.15); // ~150KB per image
                
                DOM.expectedPages.textContent = expectedPages;
                DOM.summarySelected.textContent = totalSelected;
                DOM.summaryExcluded.textContent = totalExcluded;
                DOM.summaryLayout.textContent = `${State.layout} صور/صفحة`;
                DOM.summarySize.textContent = `~${estimatedSize < 1 ? '< 1' : estimatedSize} MB`;
                
                // Update switches
                DOM.switchAutoDownload.classList.toggle('active', State.autoDownload);
                DOM.switchAddBorder.classList.toggle('active', State.addBorder);
                DOM.switchCompress.classList.toggle('active', State.compress);
            },
            
            toggleAutoDownload() {
                State.autoDownload = !State.autoDownload;
                DOM.switchAutoDownload.classList.toggle('active', State.autoDownload);
                this.saveSettings();
            },
            
            toggleAddBorder() {
                State.addBorder = !State.addBorder;
                DOM.switchAddBorder.classList.toggle('active', State.addBorder);
                this.saveSettings();
            },
            
            toggleCompress() {
                State.compress = !State.compress;
                DOM.switchCompress.classList.toggle('active', State.compress);
                this.saveSettings();
            },
            
            saveSettings() {
                Utils.saveToStorage(CONFIG.storageKeys.settings, {
                    autoDownload: State.autoDownload,
                    addBorder: State.addBorder,
                    compress: State.compress,
                    layout: State.layout
                });
            }
        };
                // =====================================================
        // IMAGE PROCESSING
        // =====================================================
        const ImageProcessor = {
            // Compress image
            async compress(dataUrl) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        const maxDim = CONFIG.maxImageDimension;
                        
                        // Resize if needed
                        if (width > maxDim || height > maxDim) {
                            const ratio = Math.min(maxDim / width, maxDim / height);
                            width = Math.round(width * ratio);
                            height = Math.round(height * ratio);
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // White background
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressed = canvas.toDataURL('image/jpeg', CONFIG.jpegQuality);
                        
                        // Cleanup
                        canvas.width = canvas.height = 0;
                        
                        resolve({
                            data: compressed,
                            width,
                            height
                        });
                    };
                    img.onerror = () => {
                        resolve({ data: dataUrl, width: 100, height: 100 });
                    };
                    img.src = dataUrl;
                });
            },
            
            // Calculate perceptual hash
            async getHash(dataUrl) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const size = CONFIG.hashSize;
                        const canvas = document.createElement('canvas');
                        canvas.width = canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, size, size);
                        
                        const imageData = ctx.getImageData(0, 0, size, size).data;
                        let hash = '';
                        let sum = 0;
                        const grays = [];
                        
                        // Convert to grayscale
                        for (let i = 0; i < imageData.length; i += 4) {
                            const gray = (imageData[i] + imageData[i + 1] + imageData[i + 2]) / 3;
                            grays.push(gray);
                            sum += gray;
                        }
                        
                        // Calculate average and generate hash
                        const avg = sum / grays.length;
                        grays.forEach(gray => {
                            hash += gray > avg ? '1' : '0';
                        });
                        
                        canvas.width = canvas.height = 0;
                        resolve(hash);
                    };
                    img.onerror = () => {
                        resolve(Math.random().toString(36).substr(2, 16));
                    };
                    img.src = dataUrl;
                });
            },
            
            // Calculate hash similarity
            similarity(hash1, hash2) {
                if (hash1.length !== hash2.length) return 0;
                let matches = 0;
                for (let i = 0; i < hash1.length; i++) {
                    if (hash1[i] === hash2[i]) matches++;
                }
                return matches / hash1.length;
            },
            
            // Check if image is a logo
            isLogo(img) {
                const minSize = CONFIG.minImageSize;
                const maxLogoSize = CONFIG.maxLogoSize;
                const maxLogoDim = CONFIG.logoMaxDimension;
                
                return img.width < minSize || 
                       img.height < minSize || 
                       (img.size < maxLogoSize && img.width < maxLogoDim && img.height < maxLogoDim);
            },
            
            // Analyze images for duplicates and logos
            async analyze(images) {
                const categories = {
                    valid: [],
                    duplicate: [],
                    logo: []
                };
                
                const selectedIds = new Set();
                const hashes = new Map();
                
                for (const img of images) {
                    // Check for logos
                    if (this.isLogo(img)) {
                        img.category = 'logo';
                        categories.logo.push(img.id);
                        continue;
                    }
                    
                    // Calculate hash
                    const hash = await this.getHash(img.data);
                    img.hash = hash;
                    
                    // Check for duplicates
                    let isDuplicate = false;
                    for (const [existingHash] of hashes) {
                        if (this.similarity(hash, existingHash) > CONFIG.similarityThreshold) {
                            isDuplicate = true;
                            break;
                        }
                    }
                    
                    if (isDuplicate) {
                        img.category = 'duplicate';
                        categories.duplicate.push(img.id);
                    } else {
                        hashes.set(hash, img.id);
                        img.category = 'valid';
                        categories.valid.push(img.id);
                        selectedIds.add(img.id);
                    }
                }
                
                return { categories, selectedIds };
            },
            
            // Render PDF image object to data URL
            async renderPdfImage(obj) {
                try {
                    const maxDim = CONFIG.maxImageDimension;
                    let width = Math.min(obj.width, maxDim);
                    let height = Math.min(obj.height, maxDim);
                    
                    if (obj.width > maxDim || obj.height > maxDim) {
                        const ratio = Math.min(maxDim / obj.width, maxDim / obj.height);
                        width = Math.round(obj.width * ratio);
                        height = Math.round(obj.height * ratio);
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    
                    if (obj.bitmap) {
                        ctx.drawImage(obj.bitmap, 0, 0, width, height);
                    } else if (obj.data) {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = obj.width;
                        tempCanvas.height = obj.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        const imageData = tempCtx.createImageData(obj.width, obj.height);
                        const src = obj.data;
                        const dst = imageData.data;
                        const pixelCount = obj.width * obj.height;
                        
                        if (src.length === pixelCount * 4) {
                            // RGBA
                            dst.set(src);
                        } else if (src.length === pixelCount * 3) {
                            // RGB
                            for (let i = 0; i < pixelCount; i++) {
                                dst[i * 4] = src[i * 3];
                                dst[i * 4 + 1] = src[i * 3 + 1];
                                dst[i * 4 + 2] = src[i * 3 + 2];
                                dst[i * 4 + 3] = 255;
                            }
                        } else if (src.length === pixelCount) {
                            // Grayscale
                            for (let i = 0; i < pixelCount; i++) {
                                dst[i * 4] = dst[i * 4 + 1] = dst[i * 4 + 2] = src[i];
                                dst[i * 4 + 3] = 255;
                            }
                        } else {
                            tempCanvas.width = tempCanvas.height = 0;
                            canvas.width = canvas.height = 0;
                            return null;
                        }
                        
                        tempCtx.putImageData(imageData, 0, 0);
                        ctx.drawImage(tempCanvas, 0, 0, width, height);
                        tempCanvas.width = tempCanvas.height = 0;
                    } else {
                        canvas.width = canvas.height = 0;
                        return null;
                    }
                    
                    const result = canvas.toDataURL('image/jpeg', CONFIG.jpegQuality);
                    canvas.width = canvas.height = 0;
                    return result;
                } catch (e) {
                    console.warn('Render image error:', e);
                    return null;
                }
            },
            
            // Convert to JPEG
            async toJPEG(dataUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0);
                            const result = canvas.toDataURL('image/jpeg', 0.7);
                            canvas.width = canvas.height = 0;
                            resolve(result);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = reject;
                    img.src = dataUrl;
                });
            }
        };

        // =====================================================
        // PDF EXTRACTOR
        // =====================================================
        const PDFExtractor = {
            async extract(file, onProgress) {
                const arrayBuffer = await Utils.readFileAsArrayBuffer(file);
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const images = [];
                let imageId = 0;
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    if (onProgress) {
                        onProgress({
                            type: 'page',
                            current: pageNum,
                            total: pdf.numPages,
                            percent: (pageNum / pdf.numPages) * 100
                        });
                    }
                    
                    try {
                        const page = await pdf.getPage(pageNum);
                        const ops = await page.getOperatorList();
                        
                        // Find image names
                        const imageNames = new Set();
                        for (let i = 0; i < ops.fnArray.length; i++) {
                            if ([82, 83, 85].includes(ops.fnArray[i])) {
                                const name = ops.argsArray[i][0];
                                if (name) imageNames.add(name);
                            }
                        }
                        
                        // Extract images
                        for (const name of imageNames) {
                            try {
                                const obj = await Promise.race([
                                    new Promise((resolve, reject) => {
                                        page.objs.get(name, (o) => o ? resolve(o) : reject());
                                    }),
                                    new Promise((_, reject) => setTimeout(() => reject(), 2000))
                                ]);
                                
                                if (obj && obj.width > 30 && obj.height > 30) {
                                    const data = await ImageProcessor.renderPdfImage(obj);
                                    if (data) {
                                        const compressed = await ImageProcessor.compress(data);
                                        images.push({
                                            id: 'img_' + imageId++,
                                            data: compressed.data,
                                            width: compressed.width,
                                            height: compressed.height,
                                            size: compressed.data.length,
                                            page: pageNum,
                                            name: `page${pageNum}_${images.length}.jpg`,
                                            category: 'valid'
                                        });
                                    }
                                }
                            } catch (e) {
                                // Skip failed images
                            }
                        }
                        
                        page.cleanup();
                        await Utils.delay(5);
                    } catch (e) {
                        console.warn('Page error:', pageNum, e);
                    }
                }
                
                return images;
            },
            
            // Render pages as images (fallback)
            async renderPages(file, onProgress) {
                const arrayBuffer = await Utils.readFileAsArrayBuffer(file);
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const images = [];
                const scale = Utils.isMobile() ? 1.0 : 1.3;
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    if (onProgress) {
                        onProgress({
                            type: 'render',
                            current: pageNum,
                            total: pdf.numPages,
                            percent: (pageNum / pdf.numPages) * 100
                        });
                    }
                    
                    try {
                        const page = await pdf.getPage(pageNum);
                        let viewport = page.getViewport({ scale });
                        
                        const maxDim = Utils.isMobile() ? 700 : 1000;
                        if (viewport.width > maxDim || viewport.height > maxDim) {
                            const ratio = Math.min(maxDim / viewport.width, maxDim / viewport.height);
                            viewport = page.getViewport({ scale: scale * ratio });
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        
                        const data = canvas.toDataURL('image/jpeg', CONFIG.jpegQuality);
                        images.push({
                            id: 'page_' + pageNum,
                            data,
                            width: canvas.width,
                            height: canvas.height,
                            size: data.length,
                            page: pageNum,
                            name: `page_${pageNum}.jpg`,
                            category: 'valid'
                        });
                        
                        page.cleanup();
                        canvas.width = canvas.height = 0;
                        await Utils.delay(15);
                    } catch (e) {
                        console.warn('Render page error:', pageNum, e);
                    }
                }
                
                return images;
            }
        };

        // =====================================================
        // PDF CREATOR
        // =====================================================
        const PDFCreator = {
            async create(options, onProgress) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: options.compress
                });
                
                const pageWidth = CONFIG.pageWidth;
                const pageHeight = CONFIG.pageHeight;
                const margin = CONFIG.pageMargin;
                const padding = CONFIG.cellPadding;
                
                const layout = CONFIG.layouts[options.layout];
                const cellWidth = (pageWidth - margin * 2) / layout.cols;
                const cellHeight = (pageHeight - margin * 2) / layout.rows;
                const imagesPerPage = layout.cols * layout.rows;
                
                const selectedImages = State.images
                    .filter(img => State.selectedIds.has(img.id))
                    .sort((a, b) => {
                        // Sort by ID to maintain order
                        const aNum = parseInt(a.id.replace(/\D/g, '')) || 0;
                        const bNum = parseInt(b.id.replace(/\D/g, '')) || 0;
                        return aNum - bNum;
                    });
                
                const totalImages = selectedImages.length;
                const totalPages = Math.ceil(totalImages / imagesPerPage);
                
                let currentPage = 0;
                let addedImages = 0;
                
                for (let i = 0; i < totalImages; i++) {
                    const positionOnPage = i % imagesPerPage;
                    const col = positionOnPage % layout.cols;
                    const row = Math.floor(positionOnPage / layout.cols);
                    
                    // Add new page if needed
                    if (positionOnPage === 0 && i > 0) {
                        doc.addPage();
                    }
                    
                    if (positionOnPage === 0) {
                        currentPage++;
                    }
                    
                    const img = selectedImages[i];
                    const x = margin + col * cellWidth;
                    const y = margin + row * cellHeight;
                    
                    try {
                        let imageData = img.data;
                        
                        // Ensure JPEG format
                        if (!imageData.includes('data:image/jpeg')) {
                            imageData = await ImageProcessor.toJPEG(imageData);
                        }
                        
                        // Calculate dimensions maintaining aspect ratio
                        const maxWidth = cellWidth - padding * 2;
                        const maxHeight = cellHeight - padding * 2;
                        const imgRatio = (img.width || 100) / (img.height || 100);
                        const cellRatio = maxWidth / maxHeight;
                        
                        let drawWidth, drawHeight;
                        if (imgRatio > cellRatio) {
                            drawWidth = maxWidth;
                            drawHeight = maxWidth / imgRatio;
                        } else {
                            drawHeight = maxHeight;
                            drawWidth = maxHeight * imgRatio;
                        }
                        
                        const drawX = x + padding + (maxWidth - drawWidth) / 2;
                        const drawY = y + padding + (maxHeight - drawHeight) / 2;
                        
                        // Draw border if enabled
                        if (options.addBorder) {
                            doc.setDrawColor(230, 230, 230);
                            doc.setLineWidth(0.1);
                            doc.rect(x + padding, y + padding, maxWidth, maxHeight);
                        }
                        
                        // Add image
                        doc.addImage(imageData, 'JPEG', drawX, drawY, drawWidth, drawHeight);
                        addedImages++;
                        
                    } catch (e) {
                        console.warn('Image add error:', i, e);
                        // Draw placeholder
                        doc.setFillColor(245, 245, 245);
                        doc.rect(x + padding, y + padding, cellWidth - padding * 2, cellHeight - padding * 2, 'F');
                    }
                    
                    // Update progress
                    if (onProgress) {
                        onProgress({
                            percent: ((i + 1) / totalImages) * 100,
                            currentImage: addedImages,
                            currentPage: currentPage,
                            totalPages: totalPages,
                            status: `صفحة ${currentPage} من ${totalPages}`
                        });
                    }
                    
                    // Yield to prevent UI freeze
                    if (i % 2 === 0) {
                        await Utils.delay(5);
                    }
                }
                
                if (addedImages === 0) {
                    throw new Error('لم تتم إضافة أي صور');
                }
                
                // Set document properties
                doc.setProperties({
                    title: options.filename || 'PDF Document',
                    author: CONFIG.author,
                    creator: `PDF Maker Pro v${CONFIG.version}`,
                    subject: 'Generated PDF'
                });
                
                // Generate blob
                const blob = doc.output('blob');
                
                return {
                    blob,
                    stats: {
                        images: addedImages,
                        pages: currentPage,
                        size: blob.size
                    }
                };
            }
        };

        // =====================================================
        // FILE HANDLER
        // =====================================================
        const FileHandler = {
            async handlePDF(file) {
                const startTime = Date.now();
                
                State.fileName = file.name.replace('.pdf', '');
                State.fileSize = file.size;
                State.mode = 'pdf';
                
                // Update UI
                DOM.fileInfo.classList.remove('hidden');
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = Utils.formatSize(file.size);
                DOM.tipsSection.classList.add('hidden');
                DOM.processingStatus.classList.remove('hidden');
                DOM.dropZone.classList.add('processing');
                
                try {
                    // Extract images
                    let images = await PDFExtractor.extract(file, (progress) => {
                        DOM.processingText.textContent = 'جاري استخراج الصور...';
                        DOM.processingBar.style.width = progress.percent + '%';
                        DOM.processingDetail.textContent = `صفحة ${progress.current} من ${progress.total}`;
                    });
                    
                    // If no images found, render pages
                    if (images.length === 0) {
                        DOM.processingText.textContent = 'جاري تحويل الصفحات...';
                        images = await PDFExtractor.renderPages(file, (progress) => {
                            DOM.processingBar.style.width = progress.percent + '%';
                            DOM.processingDetail.textContent = `صفحة ${progress.current} من ${progress.total}`;
                        });
                    }
                    
                    if (images.length === 0) {
                        throw new Error('لم يتم العثور على صور');
                    }
                    
                    // Analyze images
                    DOM.processingText.textContent = 'جاري تحليل الصور...';
                    DOM.processingBar.style.width = '90%';
                    
                    const analysis = await ImageProcessor.analyze(images);
                    
                    // Update state
                    State.images = images;
                    State.categories = analysis.categories;
                    State.selectedIds = analysis.selectedIds;
                    
                    // Calculate time
                    const processingTime = (Date.now() - startTime) / 1000;
                    
                    // Show results
                    this.showResults(processingTime);
                    
                } catch (error) {
                    console.error('PDF processing error:', error);
                    Toast.error('خطأ: ' + error.message);
                    this.resetUI();
                }
            },
            
            async handleImages(files) {
                const startTime = Date.now();
                
                State.fileName = 'images';
                State.mode = 'images';
                
                // Sort files by name
                const sortedFiles = Array.from(files)
                    .filter(f => f.type.startsWith('image/'))
                    .sort((a, b) => a.name.localeCompare(b.name, 'ar', { numeric: true }));
                
                if (sortedFiles.length === 0) {
                    Toast.error('لا توجد صور صالحة');
                    return;
                }
                
                // Update UI
                DOM.fileInfo.classList.remove('hidden');
                document.getElementById('file-name').textContent = `${sortedFiles.length} صورة`;
                document.getElementById('file-size').textContent = 'جاري التحميل...';
                DOM.tipsSection.classList.add('hidden');
                DOM.processingStatus.classList.remove('hidden');
                DOM.dropZone.classList.add('processing');
                
                try {
                    const images = [];
                    
                    for (let i = 0; i < sortedFiles.length; i++) {
                        const file = sortedFiles[i];
                        
                        DOM.processingText.textContent = 'جاري تحميل الصور...';
                        DOM.processingBar.style.width = ((i + 1) / sortedFiles.length * 80) + '%';
                        DOM.processingDetail.textContent = `صورة ${i + 1} من ${sortedFiles.length}`;
                        
                        const dataUrl = await Utils.readFileAsDataURL(file);
                        const compressed = await ImageProcessor.compress(dataUrl);
                        
                        images.push({
                            id: 'img_' + i,
                            data: compressed.data,
                            width: compressed.width,
                            height: compressed.height,
                            size: compressed.data.length,
                            name: file.name,
                            category: 'valid'
                        });
                        
                        if (i % 3 === 0) {
                            await Utils.delay(5);
                        }
                    }
                    
                    // Analyze
                    DOM.processingText.textContent = 'جاري تحليل الصور...';
                    DOM.processingBar.style.width = '90%';
                    
                    const analysis = await ImageProcessor.analyze(images);
                    
                    State.images = images;
                    State.categories = analysis.categories;
                    State.selectedIds = analysis.selectedIds;
                    
                    const processingTime = (Date.now() - startTime) / 1000;
                    this.showResults(processingTime);
                    
                } catch (error) {
                    console.error('Image processing error:', error);
                    Toast.error('خطأ في معالجة الصور');
                    this.resetUI();
                }
            },
            
            showResults(processingTime) {
                DOM.processingStatus.classList.add('hidden');
                DOM.statsSection.classList.remove('hidden');
                DOM.dropZone.classList.remove('processing');
                
                DOM.statTotal.textContent = State.images.length;
                DOM.statValid.textContent = State.categories.valid.length;
                DOM.statDuplicates.textContent = State.categories.duplicate.length;
                DOM.statLogos.textContent = State.categories.logo.length;
                DOM.statTime.textContent = Utils.formatTime(processingTime);
                
                document.getElementById('file-size').textContent = `${State.categories.valid.length} صورة صالحة`;
                DOM.pdfFilename.value = State.fileName + '_output';
                
                Toast.success(`تم استخراج ${State.images.length} صورة، ${State.categories.valid.length} صالحة`);
            },
            
            resetUI() {
                DOM.processingStatus.classList.add('hidden');
                DOM.statsSection.classList.add('hidden');
                DOM.fileInfo.classList.add('hidden');
                DOM.tipsSection.classList.remove('hidden');
                DOM.dropZone.classList.remove('processing');
                DOM.dropZoneTitle.textContent = 'اضغط لاختيار ملف';
                DOM.dropZoneSubtitle.textContent = 'أو اسحب الملف هنا';
            }
        };

        // =====================================================
        // DOWNLOAD & SHARE
        // =====================================================
        const FileExport = {
            download() {
                if (!State.pdfBlob) {
                    Toast.error('لا يوجد ملف للتحميل');
                    return;
                }
                
                const filename = (DOM.pdfFilename.value || 'document') + '.pdf';
                
                try {
                    const url = URL.createObjectURL(State.pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    
                    if (Utils.isIOS()) {
                        window.open(url, '_blank');
                        Toast.success('تم فتح الملف في نافذة جديدة');
                    } else {
                        a.click();
                        Toast.success('جاري تحميل: ' + filename);
                    }
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 1000);
                    
                } catch (e) {
                    console.error('Download error:', e);
                    this.preview();
                }
            },
            
            async share() {
                if (!State.pdfBlob) {
                    Toast.error('لا يوجد ملف للمشاركة');
                    return;
                }
                
                const filename = (DOM.pdfFilename.value || 'document') + '.pdf';
                
                try {
                    const file = new File([State.pdfBlob], filename, { type: 'application/pdf' });
                    
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: filename.replace('.pdf', ''),
                            text: 'ملف PDF من PDF Maker Pro'
                        });
                        Toast.success('تمت المشاركة بنجاح');
                    } else {
                        this.download();
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error('Share error:', e);
                        this.download();
                    }
                }
            },
            
            preview() {
                if (!State.pdfBlob) {
                    Toast.error('لا يوجد ملف للمعاينة');
                    return;
                }
                
                try {
                    const url = URL.createObjectURL(State.pdfBlob);
                    window.open(url, '_blank');
                    Toast.success('تم فتح المعاينة');
                } catch (e) {
                    console.error('Preview error:', e);
                    Toast.error('خطأ في فتح المعاينة');
                }
            }
        };

        // =====================================================
        // APP CONTROLLER
        // =====================================================
        const App = {
            async createPDF() {
                if (State.selectedIds.size === 0) {
                    Toast.warning('يرجى تحديد صور أولاً');
                    return;
                }
                
                State.isProcessing = true;
                Navigation.goTo('processing');
                
                try {
                    const result = await PDFCreator.create({
                        layout: State.layout,
                        filename: DOM.pdfFilename.value || 'document',
                        addBorder: State.addBorder,
                        compress: State.compress
                    }, (progress) => {
                        // Update circular progress
                        const offset = 553 - (progress.percent / 100) * 553;
                        DOM.progressCircle.style.strokeDashoffset = offset;
                        DOM.progressPercent.textContent = Math.round(progress.percent) + '%';
                        DOM.progressStatus.textContent = progress.status;
                        DOM.liveImages.textContent = progress.currentImage;
                        DOM.livePages.textContent = progress.currentPage;
                        DOM.currentAction.textContent = `إضافة الصورة ${progress.currentImage}...`;
                    });
                    
                    State.pdfBlob = result.blob;
                    State.resultStats = result.stats;
                    
                    // Update stats
                    State.totalConverted++;
                    State.totalImages += result.stats.images;
                    Utils.saveToStorage(CONFIG.storageKeys.stats, {
                        totalConverted: State.totalConverted,
                        totalImages: State.totalImages
                    });
                    
                    // Show result
                    this.showResult();
                    
                    // Auto download
                    if (State.autoDownload) {
                        setTimeout(() => FileExport.download(), 500);
                    }
                    
                } catch (e) {
                    console.error('PDF creation error:', e);
                    Toast.error('خطأ: ' + e.message);
                    Navigation.goTo('settings');
                } finally {
                    State.isProcessing = false;
                }
            },
            
            showResult() {
                Navigation.goTo('result');
                
                const filename = (DOM.pdfFilename.value || 'document') + '.pdf';
                
                DOM.resultImages.textContent = State.resultStats.images;
                DOM.resultPages.textContent = State.resultStats.pages;
                DOM.resultFilename.textContent = filename;
                DOM.resultFilesize.textContent = Utils.formatSize(State.resultStats.size);
            },
            
            reset() {
                State.images = [];
                State.selectedIds = new Set();
                State.categories = { valid: [], duplicate: [], logo: [] };
                State.pdfBlob = null;
                State.currentFilter = 'all';
                
                FileHandler.resetUI();
            },
            
            updateWelcomeStats() {
                DOM.totalConverted.textContent = State.totalConverted;
                DOM.totalImages.textContent = State.totalImages;
            }
        };

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        function initEventListeners() {
            // Welcome page
            DOM.btnStartPdf.addEventListener('click', () => {
                State.mode = 'pdf';
                DOM.filePageTitle.textContent = 'اختر ملف PDF';
                DOM.filePageSubtitle.textContent = 'سيتم استخراج الصور تلقائياً';
                DOM.dropZoneIcon.textContent = 'picture_as_pdf';
                App.reset();
                Navigation.goTo('file');
            });
            
            DOM.btnStartImages.addEventListener('click', () => {
                State.mode = 'images';
                DOM.filePageTitle.textContent = 'اختر الصور';
                DOM.filePageSubtitle.textContent = 'اختر صورة واحدة أو أكثر';
                DOM.dropZoneIcon.textContent = 'photo_library';
                App.reset();
                Navigation.goTo('file');
            });
            
            DOM.btnSettings.addEventListener('click', () => {
                DOM.settingsModal.classList.add('show');
                DOM.settingsSheet.classList.add('show');
            });
            
            // File page
            DOM.btnBackFile.addEventListener('click', () => Navigation.goBack());
            
            DOM.dropZone.addEventListener('click', () => {
                if (State.mode === 'pdf') {
                    DOM.inputPdf.click();
                } else {
                    DOM.inputImages.click();
                }
            });
            
            DOM.inputPdf.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) FileHandler.handlePDF(file);
            });
            
            DOM.inputImages.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    FileHandler.handleImages(e.target.files);
                }
            });
            
            DOM.btnContinueGallery.addEventListener('click', () => {
                Navigation.goTo('gallery');
            });
            
            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                DOM.dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            ['dragenter', 'dragover'].forEach(event => {
                DOM.dropZone.addEventListener(event, () => {
                    DOM.dropZone.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(event => {
                DOM.dropZone.addEventListener(event, () => {
                    DOM.dropZone.classList.remove('dragover');
                });
            });
            
            DOM.dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (State.mode === 'pdf' && files[0].type === 'application/pdf') {
                        FileHandler.handlePDF(files[0]);
                    } else if (State.mode === 'images') {
                        FileHandler.handleImages(files);
                    }
                }
            });
            
            // Gallery page
            DOM.btnBackGallery.addEventListener('click', () => Navigation.goBack());
            
            DOM.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    Gallery.setFilter(tab.dataset.filter);
                });
            });
            
            DOM.btnSelectAll.addEventListener('click', () => Gallery.selectAll());
            
            DOM.btnContinueSettings.addEventListener('click', () => {
                if (State.selectedIds.size === 0) {
                    Toast.warning('يرجى تحديد صورة واحدة على الأقل');
                    return;
                }
                Navigation.goTo('settings');
            });
            
            // Settings page
            DOM.btnBackSettings.addEventListener('click', () => Navigation.goBack());
            
            DOM.toggleAutoDownload.addEventListener('click', () => Settings.toggleAutoDownload());
            DOM.toggleAddBorder.addEventListener('click', () => Settings.toggleAddBorder());
            DOM.toggleCompress.addEventListener('click', () => Settings.toggleCompress());
            
            DOM.btnCreatePdf.addEventListener('click', () => App.createPDF());
            
            // Result page
            DOM.btnDownload.addEventListener('click', () => FileExport.download());
            DOM.btnShare.addEventListener('click', () => FileExport.share());
            DOM.btnPreview.addEventListener('click', () => FileExport.preview());
            DOM.btnNewConversion.addEventListener('click', () => {
                App.reset();
                Navigation.goTo('welcome');
            });
            
            // Viewer
            document.getElementById('viewer-close').addEventListener('click', () => Viewer.close());
            document.getElementById('viewer-prev').addEventListener('click', () => Viewer.prev());
            document.getElementById('viewer-next').addEventListener('click', () => Viewer.next());
            DOM.viewerToggle.addEventListener('click', () => Viewer.toggleSelection());
            
            // Viewer swipe
            let touchStartX = 0;
            DOM.viewer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            }, { passive: true });
            
            DOM.viewer.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                Viewer.handleSwipe(touchStartX, touchEndX);
            });
            
            // Settings modal
            DOM.settingsModal.addEventListener('click', () => {
                DOM.settingsModal.classList.remove('show');
                DOM.settingsSheet.classList.remove('show');
            });
            
            DOM.closeSettings.addEventListener('click', () => {
                DOM.settingsModal.classList.remove('show');
                DOM.settingsSheet.classList.remove('show');
            });
            
            DOM.themeToggle.addEventListener('click', () => {
                State.darkMode = !State.darkMode;
                const theme = State.darkMode ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                DOM.themeSwitch.classList.toggle('active', State.darkMode);
                Utils.saveToStorage(CONFIG.storageKeys.theme, theme);
            });
            
            // Back button handling
            window.addEventListener('popstate', () => {
                if (Viewer.isOpen) {
                    Viewer.close();
                    history.pushState(null, '', '');
                } else if (State.currentPage !== 'welcome' && !State.isProcessing) {
                    Navigation.goBack();
                    history.pushState(null, '', '');
                }
            });
            
            history.pushState(null, '', '');
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (Viewer.isOpen) {
                    if (e.key === 'Escape') Viewer.close();
                    if (e.key === 'ArrowLeft') Viewer.next();
                    if (e.key === 'ArrowRight') Viewer.prev();
                    if (e.key === ' ') {
                        e.preventDefault();
                        Viewer.toggleSelection();
                    }
                }
            });
            
            // Prevent context menu on images
            document.addEventListener('contextmenu', (e) => {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                }
            });
            
            // Button ripple effect
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
                    ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // =====================================================
        // SERVICE WORKER REGISTRATION
        // =====================================================
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('ServiceWorker registered:', registration.scope);
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                Toast.info('تحديث جديد متاح، أعد تحميل الصفحة');
                            }
                        });
                    });
                } catch (error) {
                    console.log('ServiceWorker registration failed:', error);
                }
            }
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        async function init() {
            // Wait for libraries to load
            await new Promise(resolve => {
                if (window.pdfjsLib && window.jspdf) {
                    resolve();
                } else {
                    const check = setInterval(() => {
                        if (window.pdfjsLib && window.jspdf) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                }
            });
            
            // Configure PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Cache DOM elements
            cacheDOM();
            
            // Initialize components
            Settings.initLayouts();
            
            // Setup event listeners
            initEventListeners();
            
            // Register service worker
            registerServiceWorker();
            
            // Show splash and then hide
            await Splash.show();
            
            // Update welcome stats
            App.updateWelcomeStats();
            
            console.log(`PDF Maker Pro v${CONFIG.version} initialized`);
        }

        // Start app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
